<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Itsbad Store - Toko Online</title>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõçÔ∏è</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
    .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #qrContainer img { margin: 0 auto; border: 4px solid white; border-radius: 8px; }
    .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .fade-in { animation: fadeIn 0.4s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
  </style>
</head>
<body class="flex justify-center min-h-screen text-slate-800">

  <div class="w-full max-w-md bg-white shadow-2xl min-h-screen relative flex flex-col overflow-hidden">
    
    <!-- NAVBAR -->
    <div class="glass-nav p-4 z-50 sticky top-0 flex justify-between items-center h-16">
        <div class="flex items-center gap-2">
            <div onclick="window.showProfile()" class="cursor-pointer">
                <div id="userAvatar" class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden">
                    <i class="fas fa-user text-slate-400"></i>
                </div>
            </div>
            <div>
                <h1 class="text-sm font-bold leading-tight" id="shopNameDisplay">Itsbad Store</h1>
                <p class="text-[10px] text-slate-500" id="userNameDisplay">Menunggu Login...</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="window.toggleCart()" class="relative p-2 text-slate-600 hover:text-indigo-600 transition">
                <i class="fas fa-shopping-bag text-xl"></i>
                <span id="cartCount" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full hidden">0</span>
            </button>
            <!-- Tombol admin disembunyikan, hanya bisa akses via /?page=admin -->
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 overflow-y-auto p-4 bg-slate-50 relative no-scrollbar" id="mainContainer">

      <!-- AUTH OVERLAY -->
      <div id="authOverlay" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center p-6 hidden">
          <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-6 animate-bounce">
              <i class="fas fa-store text-3xl text-indigo-600"></i>
          </div>
          <h2 class="text-2xl font-bold mb-2">Selamat Datang</h2>
          <p class="text-slate-500 text-sm mb-8 text-center">Masuk untuk mulai belanja dan simpan riwayat.</p>
          
          <button onclick="window.loginGoogle()" class="w-full bg-white border border-slate-200 py-3.5 rounded-xl font-bold text-slate-700 flex items-center justify-center gap-3 shadow-sm hover:bg-slate-50 transition mb-3">
              <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5"> Masuk dengan Google
          </button>
          
          <button onclick="window.loginGuest()" class="w-full bg-slate-100 py-3.5 rounded-xl font-bold text-slate-600 hover:bg-slate-200 transition">
              Lanjut sebagai Tamu
          </button>
          
          <p class="text-[10px] text-slate-400 mt-6 text-center max-w-xs">
              Pastikan "Google Sign-in" sudah diaktifkan di Firebase Console agar tombol Google berfungsi.
          </p>
      </div>

      <!-- SHOP PAGE -->
      <div id="page-shop">
        <div id="productGrid" class="grid grid-cols-2 gap-3 pb-24">
            <div class="col-span-2 text-center py-20 text-slate-400">
                <div class="loader mx-auto mb-2"></div> Memuat Produk...
            </div>
        </div>
      </div>

    </div>

    <!-- CART MODAL -->
    <div id="cartModal" class="fixed inset-0 z-50 pointer-events-none">
        <div class="absolute inset-0 bg-black/40 opacity-0 transition-opacity duration-300" id="cartBackdrop" onclick="window.toggleCart()"></div>
        
        <div class="absolute bottom-0 left-0 w-full bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 pointer-events-auto max-h-[85vh] flex flex-col" id="cartSheet">
            
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg">Keranjang Belanja</h3>
                <button onclick="window.toggleCart()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500"><i class="fas fa-times"></i></button>
            </div>

            <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar min-h-[200px]">
                <div class="text-center text-slate-400 py-10">Keranjang kosong</div>
            </div>

            <div class="p-5 bg-slate-50 border-t border-slate-200">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-slate-500">Subtotal</span>
                    <span class="font-bold" id="cartSubtotal">Rp 0</span>
                </div>
                <div class="flex justify-between text-sm mb-4 text-orange-500">
                    <span>Biaya Layanan</span>
                    <span class="font-bold" id="cartFee">+ Rp 0</span>
                </div>
                <div class="flex justify-between text-xl font-bold text-indigo-700 mb-4">
                    <span>Total</span>
                    <span id="cartTotal">Rp 0</span>
                </div>
                <button onclick="window.processCheckout()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">
                    BAYAR SEKARANG
                </button>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="paymentModal" class="fixed inset-0 bg-white z-[60] hidden flex-col">
        <div class="p-4 border-b flex items-center gap-3">
            <button onclick="window.closePayment()" class="text-slate-500"><i class="fas fa-arrow-left text-xl"></i></button>
            <h2 class="font-bold text-lg">Pembayaran</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-5 text-center">
            <div class="bg-indigo-50 p-6 rounded-2xl mb-6 border border-indigo-100">
                <p class="text-xs text-indigo-400 font-bold uppercase mb-2">Total Tagihan</p>
                <h1 class="text-3xl font-bold text-indigo-700" id="payTotal">Rp 0</h1>
            </div>

            <div class="bg-white border p-4 rounded-xl mb-6 relative overflow-hidden">
                <p class="text-xs font-bold text-slate-400 mb-3">SCAN QRIS DI BAWAH</p>
                <div id="qrContainer" class="flex justify-center min-h-[200px] items-center">
                    <p class="text-xs text-slate-300">QR Loading...</p>
                </div>
                <p class="text-[10px] text-slate-400 mt-3" id="qrNote">Nominal otomatis masuk</p>
            </div>

            <div class="text-left space-y-3">
                <label class="text-xs font-bold text-slate-500 ml-1">Nama Pembeli</label>
                <input type="text" id="custName" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="Nama Anda..." readonly>
                
                <label class="text-xs font-bold text-slate-500 ml-1">Upload Bukti</label>
                <input type="file" id="proofFile" accept="image/*" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </div>
        </div>
        <div class="p-4 border-t">
            <button onclick="window.sendOrder()" class="w-full bg-green-500 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                <i class="fab fa-whatsapp text-xl"></i> KIRIM BUKTI
            </button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profileModal" class="fixed inset-0 bg-white z-[70] hidden flex-col overflow-y-auto">
        <div class="sticky top-0 bg-white p-4 shadow-sm flex justify-between items-center z-10">
            <h2 class="font-bold text-lg">Profil Saya</h2>
            <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-5">
            <!-- Avatar Section -->
            <div class="flex flex-col items-center mb-6">
                <div class="relative">
                    <div id="profileAvatar" class="w-28 h-28 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden border-4 border-white shadow-lg">
                        <i class="fas fa-user text-slate-400 text-4xl"></i>
                    </div>
                    <label for="avatarUpload" class="absolute bottom-0 right-0 w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white cursor-pointer shadow-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-camera text-sm"></i>
                    </label>
                    <input type="file" id="avatarUpload" accept="image/*" class="hidden">
                </div>
                <h3 class="font-bold text-xl mt-4" id="profileName">Loading...</h3>
                <p class="text-sm text-slate-500" id="profileEmail">Loading...</p>
            </div>

            <!-- Profile Form -->
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <label class="text-xs font-bold text-slate-500 mb-2 block">Informasi Pribadi</label>
                    
                    <div class="mb-3">
                        <label class="text-xs text-slate-500">Nama Lengkap</label>
                        <input type="text" id="editName" class="w-full p-3 border rounded-lg bg-white mt-1" placeholder="Masukkan nama lengkap">
                    </div>
                    
                    <div class="mb-3">
                        <label class="text-xs text-slate-500">Nomor WhatsApp</label>
                        <div class="flex gap-2 mt-1">
                            <div class="flex items-center px-3 bg-slate-100 border rounded-lg">
                                <span class="text-slate-600">+62</span>
                            </div>
                            <input type="tel" id="editPhone" class="flex-1 p-3 border rounded-lg bg-white" placeholder="81234567890">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="text-xs text-slate-500">Alamat Pengiriman</label>
                        <textarea id="editAddress" class="w-full p-3 border rounded-lg bg-white mt-1" rows="3" placeholder="Masukkan alamat lengkap"></textarea>
                    </div>
                </div>

                <div class="bg-amber-50 p-4 rounded-xl border border-amber-100">
                    <h4 class="font-bold text-sm text-amber-800 mb-2"><i class="fas fa-history mr-2"></i>Riwayat Belanja</h4>
                    <div id="orderHistory" class="text-sm text-amber-600">
                        <p class="text-center py-4">Belum ada riwayat pembelian</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 space-y-3">
                <button onclick="window.saveProfile()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-save"></i> SIMPAN PROFIL
                </button>
                
                <button onclick="window.logout()" class="w-full bg-slate-100 text-slate-600 py-3.5 rounded-xl font-bold hover:bg-slate-200 transition flex items-center justify-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> KELUAR
                </button>
            </div>
        </div>
    </div>

    <!-- PRODUCT DETAIL MODAL -->
    <div id="productDetailModal" class="fixed inset-0 modal-overlay z-[80] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto no-scrollbar slide-up">
            <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center z-10">
                <h2 class="font-bold text-lg">Detail Produk</h2>
                <button onclick="window.closeProductDetail()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-5">
                <div id="detailImage" class="w-full h-56 bg-indigo-50 rounded-xl mb-4 flex items-center justify-center text-indigo-200">
                    <i class="fas fa-box text-6xl"></i>
                </div>
                
                <div class="mb-6">
                    <h1 id="detailName" class="text-2xl font-bold text-slate-800 mb-2">Nama Produk</h1>
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p id="detailPrice" class="text-3xl font-bold text-indigo-600">Rp 0</p>
                            <p id="detailStock" class="text-sm text-slate-500 mt-1">Stok: 0</p>
                        </div>
                        <div class="bg-green-50 px-3 py-1 rounded-full">
                            <span id="detailCategory" class="text-xs font-bold text-green-600">PRODUK</span>
                        </div>
                    </div>
                    <p id="detailDescription" class="text-slate-600">Deskripsi produk akan muncul di sini.</p>
                </div>
                
                <div class="flex gap-3">
                    <button id="detailAddToCart" onclick="window.addToCartFromDetail()" class="flex-1 bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-indigo-600 transition flex items-center justify-center gap-2">
                        <i class="fas fa-cart-plus"></i> TAMBAH
                    </button>
                    <button onclick="window.buyNowFromDetail()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-bolt"></i> BELI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL (Hidden, only accessible via /?page=admin) -->
    <div id="adminPanel" class="fixed inset-0 bg-slate-50 z-[90] hidden overflow-y-auto">
        <div class="sticky top-0 bg-white p-4 shadow-sm flex justify-between items-center z-10">
            <h2 class="font-bold text-lg">Admin Dashboard</h2>
            <button onclick="document.getElementById('adminPanel').classList.add('hidden')" class="text-sm font-bold text-red-500">Tutup</button>
        </div>
        
        <div id="adminLoginForm" class="p-10 text-center mt-20">
            <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-lock text-slate-500 text-2xl"></i>
            </div>
            <h3 class="font-bold text-lg mb-4">Akses Admin</h3>
            <input type="password" id="adminPin" class="w-full p-4 rounded-xl border text-center text-xl mb-4 bg-white shadow-sm" placeholder="Masukkan PIN" maxlength="6">
            <button onclick="window.loginAdmin()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg">MASUK</button>
        </div>

        <div id="adminContent" class="p-4 space-y-6 hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm">
                <h3 class="font-bold text-sm mb-3 text-slate-500 uppercase">Pengaturan Toko</h3>
                <input type="text" id="setStoreName" class="w-full p-2 border rounded mb-2 text-sm" placeholder="Nama Toko" value="Itsbad Store">
                <input type="number" id="setFee" class="w-full p-2 border rounded mb-2 text-sm" placeholder="Biaya Admin (Rp)">
                
                <p class="text-xs font-bold mt-2 mb-1">Upload QRIS</p>
                <div class="bg-blue-50 p-2 rounded text-[10px] text-blue-600 mb-2">
                    Gunakan QRIS Merchant (Dana Bisnis/Shopee Partner) agar nominal otomatis masuk.
                </div>
                <input type="file" id="qrisUpload" class="text-xs w-full mb-2">
                <textarea id="setQris" class="w-full p-2 text-[10px] bg-slate-100 rounded font-mono" rows="2" readonly placeholder="String QRIS..."></textarea>
                
                <button onclick="window.saveSettings()" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold mt-2">SIMPAN SETTINGS</button>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm">
                <h3 class="font-bold text-sm mb-3 text-slate-500 uppercase">Tambah Produk</h3>
                <input type="text" id="newProdName" class="w-full p-2 border rounded mb-2 text-sm" placeholder="Nama Produk">
                <div class="flex gap-2 mb-2">
                    <input type="number" id="newProdPrice" class="w-1/2 p-2 border rounded text-sm" placeholder="Harga">
                    <input type="number" id="newProdStock" class="w-1/2 p-2 border rounded text-sm" placeholder="Stok">
                </div>
                <textarea id="newProdDesc" class="w-full p-2 border rounded mb-2 text-sm" placeholder="Deskripsi Produk" rows="2"></textarea>
                
                <button onclick="window.addProduct()" class="w-full bg-green-500 text-white py-2 rounded-lg text-sm font-bold">TAMBAH PRODUK</button>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm">
                <h3 class="font-bold text-sm mb-3 text-slate-500 uppercase">Daftar Produk</h3>
                <div id="adminProdList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
            
            <div class="h-10"></div>
        </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAUL2WkPlJLb8wHcSKQ_QA7GSZ5DGw94Ng",
      authDomain: "kasir-online-c22bd.firebaseapp.com",
      databaseURL: "https://kasir-online-c22bd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kasir-online-c22bd",
      storageBucket: "kasir-online-c22bd.firebasestorage.app",
      messagingSenderId: "1052259146588",
      appId: "1:1052259146588:web:a3f4e9c31982cbfa2dff99",
      measurementId: "G-QR6HPRX459"
    };

    const STORE_ID = "itsbad-store";
    const OWNER_WA = "6285236363128";

    // Init Variables
    let db, auth, user;
    let storeData = { name: "Itsbad Store", fee: 0, products: [] };
    let cart = JSON.parse(localStorage.getItem('myCart')) || [];
    let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
    let currentProductDetail = null;
    
    toastr.options = { "positionClass": "toast-top-center", "timeOut": "2000" };

    // Check for admin access
    const urlParams = new URLSearchParams(window.location.search);
    const isAdminPage = urlParams.get('page') === 'admin';

    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);
        
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('authOverlay').classList.add('hidden');
                loadUserProfile(u.uid);
                
                // Set initial display
                document.getElementById('userNameDisplay').innerText = userProfile.name || u.displayName || "Tamu";
                if(u.photoURL && !userProfile.avatar) {
                    document.getElementById('userAvatar').innerHTML = `<img src="${u.photoURL}" class="w-full h-full object-cover">`;
                }
                
                initStore();
                
                // Show admin panel if accessed via /?page=admin
                if(isAdminPage) {
                    setTimeout(() => {
                        document.getElementById('adminPanel').classList.remove('hidden');
                    }, 500);
                }
            } else {
                document.getElementById('authOverlay').classList.remove('hidden');
                // Hide admin panel if not authenticated
                document.getElementById('adminPanel').classList.add('hidden');
            }
        });

    } catch(e) { console.error(e); alert("Firebase Config Error: " + e.message); }

    // --- USER PROFILE FUNCTIONS ---
    async function loadUserProfile(uid) {
        try {
            const snap = await get(child(ref(db), `users/${uid}`));
            if(snap.exists()) {
                userProfile = snap.val();
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                loadOrderHistory(uid);
            } else {
                // Create default profile
                userProfile = {
                    name: user.displayName || "Tamu",
                    email: user.email || "",
                    phone: "",
                    address: "",
                    avatar: user.photoURL || "",
                    createdAt: Date.now()
                };
                await set(ref(db, `users/${uid}`), userProfile);
            }
        } catch(e) { console.log("Using local profile"); }
    }

    function updateProfileDisplay() {
        // Navbar
        document.getElementById('userNameDisplay').innerText = userProfile.name || "Tamu";
        
        // Avatar
        const avatarEl = document.getElementById('userAvatar');
        if(userProfile.avatar && userProfile.avatar !== "local") {
            avatarEl.innerHTML = `<img src="${userProfile.avatar}" class="w-full h-full object-cover" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\"fas fa-user text-slate-400\"></i>'">`;
        } else if(user.photoURL && !userProfile.avatar) {
            avatarEl.innerHTML = `<img src="${user.photoURL}" class="w-full h-full object-cover">`;
        }
        
        // Profile Modal
        document.getElementById('profileName').innerText = userProfile.name || "Tamu";
        document.getElementById('profileEmail').innerText = userProfile.email || "";
        document.getElementById('editName').value = userProfile.name || "";
        document.getElementById('editPhone').value = userProfile.phone || "";
        document.getElementById('editAddress').value = userProfile.address || "";
        
        // Profile Avatar
        const profileAvatar = document.getElementById('profileAvatar');
        if(userProfile.avatar && userProfile.avatar !== "local") {
            profileAvatar.innerHTML = `<img src="${userProfile.avatar}" class="w-full h-full object-cover" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\"fas fa-user text-slate-400 text-4xl\"></i>'">`;
        } else if(user.photoURL && !userProfile.avatar) {
            profileAvatar.innerHTML = `<img src="${user.photoURL}" class="w-full h-full object-cover">`;
        }
    }

    window.showProfile = () => {
        document.getElementById('profileModal').classList.remove('hidden');
        document.getElementById('profileModal').classList.add('flex');
    };

    window.saveProfile = async () => {
        const newName = document.getElementById('editName').value;
        const newPhone = document.getElementById('editPhone').value;
        const newAddress = document.getElementById('editAddress').value;
        
        if(!newName.trim()) {
            toastr.warning("Nama tidak boleh kosong");
            return;
        }
        
        userProfile.name = newName;
        userProfile.phone = newPhone;
        userProfile.address = newAddress;
        
        try {
            await update(ref(db, `users/${user.uid}`), userProfile);
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileDisplay();
            toastr.success("Profil berhasil disimpan!");
        } catch(e) {
            toastr.error("Gagal menyimpan profil");
        }
    };

    // Avatar Upload
    document.getElementById('avatarUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        if(file.size > 2 * 1024 * 1024) {
            toastr.warning("Ukuran maksimal 2MB");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = async (ev) => {
            userProfile.avatar = ev.target.result;
            
            // Update in Firebase
            try {
                await update(ref(db, `users/${user.uid}`), { avatar: userProfile.avatar });
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                toastr.success("Foto profil berhasil diupdate!");
            } catch(e) {
                toastr.error("Gagal mengupload foto");
            }
        };
        reader.readAsDataURL(file);
    });

    async function loadOrderHistory(uid) {
        try {
            const snap = await get(child(ref(db), `orders/${uid}`));
            const historyEl = document.getElementById('orderHistory');
            
            if(snap.exists()) {
                const orders = snap.val();
                let html = '<div class="space-y-2">';
                Object.entries(orders).reverse().slice(0, 5).forEach(([key, order]) => {
                    const date = new Date(order.timestamp || key).toLocaleDateString('id-ID');
                    html += `
                    <div class="bg-white p-3 rounded-lg border">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-amber-800">${date}</span>
                            <span class="font-bold text-green-600">Rp ${parseInt(order.total || 0).toLocaleString()}</span>
                        </div>
                        <p class="text-xs text-amber-600 truncate">${order.items || "Pesanan"}</p>
                    </div>`;
                });
                html += '</div>';
                historyEl.innerHTML = html;
            }
        } catch(e) { console.log("No order history"); }
    }

    window.logout = async () => {
        if(confirm("Yakin ingin keluar?")) {
            await signOut(auth);
            localStorage.removeItem('userProfile');
            localStorage.removeItem('myCart');
            document.getElementById('profileModal').classList.add('hidden');
            toastr.info("Anda telah keluar");
        }
    };

    // --- AUTH FUNCTIONS ---
    window.loginGoogle = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(e => {
            alert("Login Google Gagal: " + e.message + "\nPastikan Authentication Google sudah aktif di Firebase Console.");
        });
    };
    
    window.loginGuest = () => {
        signInAnonymously(auth).catch(e => {
            alert("Login Tamu Gagal: " + e.message + "\nPastikan Anonymous Auth aktif di Firebase.");
        });
    };

    // --- STORE DATA ---
    async function initStore() {
        try {
            const snap = await get(child(ref(db), `stores/${STORE_ID}`));
            if(snap.exists()) {
                storeData = snap.val();
                if(!storeData.products) storeData.products = [];
            } else {
                storeData = { name: "Itsbad Store", fee: 0, products: [] };
                await set(ref(db, `stores/${STORE_ID}`), storeData);
            }
            renderStore();
        } catch(e) { 
            console.error(e);
            toastr.error("Koneksi Database Gagal");
            // Fallback to local rendering
            renderStore();
        }
    }

    function renderStore() {
        document.getElementById('shopNameDisplay').innerText = storeData.name || "Itsbad Store";
        
        const grid = document.getElementById('productGrid');
        grid.innerHTML = "";
        
        if(storeData.products && storeData.products.length > 0) {
            storeData.products.forEach((p, i) => {
                const hasStock = parseInt(p.stock) > 0;
                grid.innerHTML += `
                <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm flex flex-col h-full relative overflow-hidden slide-up fade-in" onclick="window.showProductDetail(${i})">
                    ${!hasStock ? '<div class="absolute inset-0 bg-white/70 flex items-center justify-center font-bold text-red-500 z-10 backdrop-blur-sm">HABIS</div>' : ''}
                    <div class="w-full h-24 bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl mb-3 flex items-center justify-center text-indigo-200">
                        <i class="fas fa-box text-3xl"></i>
                    </div>
                    <h3 class="font-bold text-sm text-slate-700 leading-tight mb-1 truncate">${p.name}</h3>
                    <p class="text-xs text-slate-400 mb-2 truncate line-clamp-2 h-8">${p.desc || 'Tidak ada deskripsi'}</p>
                    <div class="mt-auto flex justify-between items-center">
                        <div>
                            <p class="font-bold text-indigo-600 text-sm">Rp ${parseInt(p.price).toLocaleString()}</p>
                            <p class="text-[10px] text-slate-400">Stok: ${p.stock}</p>
                        </div>
                        <button onclick="event.stopPropagation(); window.addToCart(${i})" class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition disabled:bg-slate-300" ${!hasStock ? 'disabled':''}>
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>`;
            });
        } else {
            grid.innerHTML = `<div class="col-span-2 text-center text-slate-400 py-10">
                <i class="fas fa-box-open text-3xl mb-2 opacity-50"></i><br>
                Belum ada produk.<br>Login Admin untuk tambah produk.
            </div>`;
        }
        updateCartBadge();
    }

    // --- PRODUCT DETAIL FUNCTIONS ---
    window.showProductDetail = (index) => {
        currentProductDetail = index;
        const p = storeData.products[index];
        
        document.getElementById('detailName').innerText = p.name;
        document.getElementById('detailPrice').innerText = `Rp ${parseInt(p.price).toLocaleString()}`;
        document.getElementById('detailStock').innerText = `Stok: ${p.stock}`;
        document.getElementById('detailDescription').innerText = p.desc || 'Tidak ada deskripsi';
        
        // Update button state
        const addBtn = document.getElementById('detailAddToCart');
        const hasStock = parseInt(p.stock) > 0;
        if(hasStock) {
            addBtn.disabled = false;
            addBtn.innerHTML = '<i class="fas fa-cart-plus"></i> TAMBAH KE KERANJANG';
            addBtn.className = "flex-1 bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-indigo-600 transition flex items-center justify-center gap-2";
        } else {
            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="fas fa-times"></i> STOK HABIS';
            addBtn.className = "flex-1 bg-slate-300 text-slate-500 py-4 rounded-xl font-bold flex items-center justify-center gap-2 cursor-not-allowed";
        }
        
        document.getElementById('productDetailModal').classList.remove('hidden');
    };

    window.closeProductDetail = () => {
        document.getElementById('productDetailModal').classList.add('hidden');
    };

    window.addToCartFromDetail = () => {
        if(currentProductDetail !== null) {
            window.addToCart(currentProductDetail);
            window.closeProductDetail();
        }
    };

    window.buyNowFromDetail = () => {
        if(currentProductDetail !== null) {
            // Add to cart and go to checkout
            const p = storeData.products[currentProductDetail];
            const exist = cart.find(c => c.index === currentProductDetail);
            
            if(!exist) {
                cart.push({ 
                    index: currentProductDetail, 
                    name: p.name, 
                    price: parseInt(p.price), 
                    qty: 1, 
                    stock: parseInt(p.stock) 
                });
                saveCart();
            }
            
            window.closeProductDetail();
            window.toggleCart();
        }
    };

    // --- CART LOGIC ---
    window.addToCart = (index) => {
        const p = storeData.products[index];
        const exist = cart.find(c => c.index === index);
        
        if(exist) {
            if(exist.qty < p.stock) exist.qty++;
            else toastr.warning("Stok maksimal!");
        } else {
            cart.push({ index, name: p.name, price: parseInt(p.price), qty: 1, stock: parseInt(p.stock) });
        }
        saveCart();
        toastr.success("Ditambahkan ke keranjang!");
    };

    window.updateQty = (idx, change) => {
        if(cart[idx].qty + change > 0 && cart[idx].qty + change <= cart[idx].stock) {
            cart[idx].qty += change;
        } else if (cart[idx].qty + change <= 0) {
            if(confirm("Hapus item dari keranjang?")) cart.splice(idx, 1);
        }
        saveCart();
    };

    function saveCart() {
        localStorage.setItem('myCart', JSON.stringify(cart));
        updateCartBadge();
        renderCart();
    }

    function updateCartBadge() {
        const count = cart.reduce((a, b) => a + b.qty, 0);
        const el = document.getElementById('cartCount');
        el.innerText = count;
        count > 0 ? el.classList.remove('hidden') : el.classList.add('hidden');
    }

    window.toggleCart = () => {
        const modal = document.getElementById('cartBackdrop');
        const sheet = document.getElementById('cartSheet');
        
        if(sheet.classList.contains('translate-y-full')) {
            renderCart();
            modal.parentElement.classList.remove('pointer-events-none');
            modal.classList.remove('opacity-0');
            sheet.classList.remove('translate-y-full');
        } else {
            modal.parentElement.classList.add('pointer-events-none');
            modal.classList.add('opacity-0');
            sheet.classList.add('translate-y-full');
        }
    };

    function renderCart() {
        const el = document.getElementById('cartItems');
        el.innerHTML = "";
        let subtotal = 0;

        if(cart.length === 0) {
            el.innerHTML = `<div class="text-center text-slate-400 py-10">
                <i class="fas fa-shopping-bag text-3xl mb-2 opacity-30"></i><br>
                Keranjang belanja kosong
            </div>`;
        } else {
            cart.forEach((c, i) => {
                subtotal += c.price * c.qty;
                el.innerHTML += `
                <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm slide-up">
                    <div class="flex-1">
                        <h4 class="font-bold text-sm text-slate-700">${c.name}</h4>
                        <p class="text-xs text-indigo-600 font-bold">Rp ${c.price.toLocaleString()}</p>
                    </div>
                    <div class="flex items-center gap-3 bg-slate-50 rounded-lg p-1">
                        <button onclick="window.updateQty(${i}, -1)" class="w-6 h-6 flex items-center justify-center text-slate-500 hover:bg-white rounded transition">-</button>
                        <span class="text-sm font-bold w-4 text-center">${c.qty}</span>
                        <button onclick="window.updateQty(${i}, 1)" class="w-6 h-6 flex items-center justify-center text-slate-500 hover:bg-white rounded transition">+</button>
                    </div>
                </div>`;
            });
        }

        const fee = parseInt(storeData.fee || 0);
        document.getElementById('cartSubtotal').innerText = "Rp " + subtotal.toLocaleString();
        document.getElementById('cartFee').innerText = "+ Rp " + fee.toLocaleString();
        document.getElementById('cartTotal').innerText = "Rp " + (subtotal + fee).toLocaleString();
    }

    // --- CHECKOUT & PAYMENT ---
    window.processCheckout = () => {
        if(cart.length === 0) return toastr.warning("Keranjang kosong!");
        
        // Validate profile data for guest users
        if(user.isAnonymous && (!userProfile.phone || !userProfile.address)) {
            toastr.warning("Isi nomor WhatsApp dan alamat terlebih dahulu!");
            window.showProfile();
            window.toggleCart();
            return;
        }
        
        window.toggleCart();
        const subtotal = cart.reduce((a, b) => a + b.qty * b.price, 0);
        const fee = parseInt(storeData.fee || 0);
        const total = subtotal + fee;

        document.getElementById('payTotal').innerText = "Rp " + total.toLocaleString();
        document.getElementById('custName').value = userProfile.name || user.displayName || "Tamu";
        document.getElementById('paymentModal').classList.remove('hidden');
        document.getElementById('paymentModal').classList.add('flex');
        
        generateQR(total);
    };

    window.closePayment = () => {
        document.getElementById('paymentModal').classList.add('hidden');
        document.getElementById('paymentModal').classList.remove('flex');
    };

    function generateQR(amount) {
        const container = document.getElementById('qrContainer');
        container.innerHTML = "";
        
        let qris = storeData.qris;
        const note = document.getElementById('qrNote');

        if(!qris) {
            container.innerHTML = `<div class="text-center">
                <i class="fas fa-qrcode text-4xl text-red-300 mb-2"></i><br>
                <span class='text-xs text-red-500'>QRIS Belum diupload Admin</span>
            </div>`;
            return;
        }

        if(qris.startsWith("http") || qris.length < 50) {
            note.innerText = "‚ö†Ô∏è Nominal wajib input manual (QR Personal)";
            note.classList.add("text-orange-500");
        } else {
            try {
                qris = injectAmount(qris, amount);
                note.innerText = "Nominal otomatis masuk";
                note.classList.remove("text-orange-500");
            } catch(e) { console.log("Static QR"); }
        }

        new QRCode(container, {
            text: qris,
            width: 200,
            height: 200,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.M
        });
    }

    function injectAmount(payload, amount) {
        let p = payload.slice(0, -4).replace("010211", "010212");
        const amStr = amount + ".00";
        const tag54 = "54" + amStr.length.toString().padStart(2,'0') + amStr;
        
        if(p.includes("5802ID")) {
            const idx = p.indexOf("5802ID");
            p = p.slice(0, idx) + tag54 + p.slice(idx);
        } else { p = p + tag54; }
        
        return p + crc16(p);
    }
    
    function crc16(s) {
        let crc = 0xFFFF;
        for (let i = 0; i < s.length; i++) {
            crc ^= s.charCodeAt(i) << 8;
            for (let j = 0; j < 8; j++) {
                crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1;
                crc = crc & 0xFFFF;
            }
        }
        return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    window.sendOrder = async () => {
        const file = document.getElementById('proofFile').files[0];
        if(!file) return toastr.warning("Upload bukti transfer!");
        
        // Create order summary
        let itemsList = "";
        cart.forEach(c => {
            itemsList += `‚ñ™Ô∏è ${c.name} (${c.qty}x) - Rp ${(c.qty*c.price).toLocaleString()}\n`;
        });
        
        const subtotal = cart.reduce((a, b) => a + b.qty * b.price, 0);
        const fee = parseInt(storeData.fee || 0);
        const total = subtotal + fee;
        
        // Customer info
        const custPhone = userProfile.phone ? `+62${userProfile.phone}` : "";
        const custAddress = userProfile.address || "";

        const msg = `*ORDER BARU - ITSBAD STORE*\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüë§ ${userProfile.name}\nüì± ${custPhone}\nüìç ${custAddress}\n\n*Pesanan:*\n${itemsList}\nSubtotal: Rp ${subtotal.toLocaleString()}\nLayanan: Rp ${fee.toLocaleString()}\n*TOTAL: Rp ${total.toLocaleString()}*\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nUser melampirkan bukti transfer.`;

        // Save order to database
        const orderData = {
            user: user.uid,
            userName: userProfile.name,
            items: cart.map(c => `${c.name} (${c.qty}x)`).join(', '),
            total: total,
            timestamp: Date.now(),
            status: "pending"
        };
        
        try {
            await push(ref(db, `orders/${user.uid}`), orderData);
            toastr.success("Pesanan tersimpan!");
        } catch(e) {
            console.error("Failed to save order:", e);
        }

        // Send WhatsApp message
        const url = `https://wa.me/${OWNER_WA}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
        
        // Clear cart and reload
        cart = [];
        saveCart();
        setTimeout(() => {
            toastr.success("Terima kasih telah berbelanja!");
            window.location.reload();
        }, 2000);
    };

    // --- ADMIN FUNCTIONS (Hidden) ---
    window.loginAdmin = () => {
        if(document.getElementById('adminPin').value === "110603") {
            document.getElementById('adminLoginForm').classList.add('hidden');
            document.getElementById('adminContent').classList.remove('hidden');
            loadAdminData();
        } else toastr.error("PIN Salah");
    };

    function loadAdminData() {
        document.getElementById('setStoreName').value = storeData.name || "Itsbad Store";
        document.getElementById('setFee').value = storeData.fee || 0;
        document.getElementById('setQris').value = storeData.qris || "";
        renderAdminList();
    }

    function renderAdminList() {
        const el = document.getElementById('adminProdList');
        el.innerHTML = "";
        if(storeData.products && storeData.products.length > 0) {
            storeData.products.forEach((p, i) => {
                el.innerHTML += `
                <div class="flex justify-between p-2 bg-slate-50 rounded border mb-1 items-center">
                    <span class="text-xs truncate w-1/2 font-bold">${p.name}</span>
                    <span class="text-xs text-slate-500">Rp ${parseInt(p.price).toLocaleString()}</span>
                    <button onclick="window.delProd(${i})" class="text-red-500 font-bold text-xs bg-white border px-2 py-1 rounded hover:bg-red-50">Hapus</button>
                </div>`;
            });
        } else {
            el.innerHTML = '<p class="text-center text-slate-400 py-4">Belum ada produk</p>';
        }
    }

    document.getElementById('qrisUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement("canvas");
                cvs.width = img.width; cvs.height = img.height;
                const ctx = cvs.getContext("2d");
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0,0,cvs.width,cvs.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if(code) {
                    document.getElementById('setQris').value = code.data;
                    toastr.success("QRIS Berhasil Dibaca!");
                } else toastr.error("QR tidak terbaca");
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    });

    window.saveSettings = async () => {
        storeData.name = document.getElementById('setStoreName').value || "Itsbad Store";
        storeData.fee = parseInt(document.getElementById('setFee').value) || 0;
        storeData.qris = document.getElementById('setQris').value;
        
        try {
            await update(ref(db, `stores/${STORE_ID}`), storeData);
            toastr.success("Pengaturan tersimpan!");
            setTimeout(() => location.reload(), 1000);
        } catch(e) {
            toastr.error("Gagal menyimpan pengaturan");
        }
    };

    window.addProduct = async () => {
        const name = document.getElementById('newProdName').value;
        const price = document.getElementById('newProdPrice').value;
        const stock = document.getElementById('newProdStock').value;
        const desc = document.getElementById('newProdDesc').value;

        if(!name || !price) return toastr.warning("Nama dan harga wajib diisi");

        if(!storeData.products) storeData.products = [];
        
        storeData.products.push({
            name, 
            price: parseInt(price) || 0,
            stock: parseInt(stock) || 0,
            desc: desc || ""
        });
        
        try {
            await update(ref(db, `stores/${STORE_ID}`), storeData);
            toastr.success("Produk berhasil ditambahkan!");
            
            // Clear form
            document.getElementById('newProdName').value = "";
            document.getElementById('newProdPrice').value = "";
            document.getElementById('newProdStock').value = "";
            document.getElementById('newProdDesc').value = "";
            
            renderAdminList();
            renderStore(); // Update shop view
        } catch(e) {
            toastr.error("Gagal menambah produk");
        }
    };

    window.delProd = async (i) => {
        if(confirm("Yakin hapus produk ini?")) {
            storeData.products.splice(i, 1);
            try {
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                toastr.success("Produk dihapus");
                renderAdminList();
                renderStore(); // Update shop view
            } catch(e) {
                toastr.error("Gagal menghapus produk");
            }
        }
    };

    // Expose Global Functions
    window.toggleCart = window.toggleCart;
    window.addToCart = window.addToCart;
    window.updateQty = window.updateQty;
    window.processCheckout = window.processCheckout;
    window.closePayment = window.closePayment;
    window.sendOrder = window.sendOrder;
    window.showProductDetail = window.showProductDetail;
    window.closeProductDetail = window.closeProductDetail;
    window.addToCartFromDetail = window.addToCartFromDetail;
    window.buyNowFromDetail = window.buyNowFromDetail;
    window.showProfile = window.showProfile;
    window.saveProfile = window.saveProfile;
    window.logout = window.logout;
    window.loginAdmin = window.loginAdmin;
    window.saveSettings = window.saveSettings;
    window.addProduct = window.addProduct;
    window.delProd = window.delProd;
    window.loginGoogle = window.loginGoogle;
    window.loginGuest = window.loginGuest;

  </script>
</body>
</html>
