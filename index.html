<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Toko Online & QRIS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
    .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    #qrContainer img { margin: 0 auto; display: block; border: 4px solid white; border-radius: 8px; }
  </style>
</head>
<body class="flex justify-center min-h-screen text-slate-800">

  <div class="w-full max-w-md bg-white shadow-2xl min-h-screen relative flex flex-col">
    
    <div class="bg-indigo-600 text-white p-5 pt-8 z-10 sticky top-0 shadow-md">
      <div class="flex justify-between items-center">
        <div>
          <h1 id="shopTitle" class="text-xl font-bold">Loading Toko...</h1>
          <p class="text-indigo-200 text-xs">Belanja Mudah & Cepat</p>
        </div>
        
        <div class="flex items-center gap-2">
            <div id="loaderIcon" class="loader"></div>
            <button onclick="window.openAdmin()" class="bg-indigo-700 hover:bg-indigo-800 p-2 rounded-full text-xs transition shadow-lg">
                <i class="fas fa-lock"></i>
            </button>
        </div>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto pb-24 p-4 bg-slate-50 relative">

      <div id="page-shop">
        
        <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
            <i class="fas fa-box-open text-indigo-500"></i> Pilih Produk
        </h3>
        <div id="productGrid" class="grid grid-cols-2 gap-3 mb-6">
            <div class="col-span-2 text-center py-10 text-slate-400">
                <div class="loader mx-auto mb-2"></div>
                Memuat Produk...
            </div>
        </div>

        <div id="checkoutArea" class="hidden bg-white p-5 rounded-2xl shadow-lg border border-indigo-100 mb-6">
            <div class="flex justify-between items-center border-b border-slate-100 pb-3 mb-3">
                <h3 class="font-bold text-lg text-slate-800">Checkout</h3>
                <button onclick="window.resetSelection()" class="text-xs text-red-500 font-bold hover:bg-red-50 px-2 py-1 rounded">Batal</button>
            </div>

            <div class="space-y-2 text-sm mb-4">
                <div class="flex justify-between">
                    <span class="text-slate-500">Item:</span>
                    <span id="billItemName" class="font-bold text-slate-700">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-500">Harga:</span>
                    <span id="billItemPrice" class="font-mono">-</span>
                </div>
                <div class="flex justify-between text-orange-500">
                    <span>Biaya Admin:</span>
                    <span id="billFee" class="font-mono">+ Rp 0</span>
                </div>
                <div class="flex justify-between text-lg font-bold text-indigo-700 border-t pt-2 mt-2">
                    <span>Total Bayar:</span>
                    <span id="billTotal">Rp 0</span>
                </div>
            </div>

            <div class="text-center bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4">
                <p class="text-xs font-bold text-slate-400 mb-2 uppercase">Scan QRIS Ini</p>
                <div id="qrContainer" class="min-h-[180px] flex items-center justify-center">
                    <p class="text-[10px] text-slate-400">QRIS akan muncul disini</p>
                </div>
                <p class="text-[10px] text-slate-400 mt-2">Nominal otomatis muncul saat scan</p>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">Nama Anda</label>
                    <input type="text" id="custName" class="w-full p-3 border rounded-xl text-sm bg-slate-50 focus:bg-white transition outline-none focus:border-indigo-500" placeholder="Ketik nama...">
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">Upload Bukti Transfer</label>
                    <div class="relative">
                        <input type="file" id="proofFile" accept="image/*" class="hidden" onchange="window.previewProof(this)">
                        <button onclick="document.getElementById('proofFile').click()" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 text-xs font-bold hover:bg-slate-50 hover:border-indigo-400 transition flex items-center justify-center gap-2">
                            <i class="fas fa-camera"></i> <span id="proofText">Pilih Foto Bukti</span>
                        </button>
                        <img id="proofPreview" class="hidden mt-2 w-full h-32 object-cover rounded-lg border">
                    </div>
                </div>

                <button onclick="window.processCheckout()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-200 flex items-center justify-center gap-2 transform active:scale-95 transition">
                    <i class="fab fa-whatsapp text-xl"></i> KIRIM KE WA ADMIN
                </button>
            </div>
        </div>

      </div>

      <div id="page-admin-login" class="hidden flex flex-col justify-center h-full text-center py-20">
        <div class="bg-white p-6 rounded-2xl shadow-sm mx-4">
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user-shield text-2xl text-slate-600"></i>
            </div>
            <h2 class="text-xl font-bold mb-4">Login Admin</h2>
            <input type="password" id="adminPin" class="w-full p-3 border rounded-xl text-center text-lg mb-4" placeholder="Masukkan PIN (110603)" maxlength="6">
            <div class="flex gap-2">
                <button onclick="window.closeAdmin()" class="flex-1 py-3 bg-slate-200 rounded-xl font-bold text-slate-600">Batal</button>
                <button onclick="window.loginAdmin()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">Masuk</button>
            </div>
        </div>
      </div>

      <div id="page-admin-dashboard" class="hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="font-bold text-xl">Pengaturan Toko</h2>
            <button onclick="window.closeAdmin()" class="text-red-500 text-xs font-bold border border-red-200 px-3 py-1 rounded-full">Keluar</button>
        </div>

        <div class="space-y-6 pb-20">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">Info & Fee</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-slate-400">Nama Toko</label>
                        <input type="text" id="setShopName" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400">Biaya Admin / Fee (Rp)</label>
                        <input type="number" id="setFee" class="w-full p-2 border rounded-lg text-sm" placeholder="Contoh: 1000">
                        <p class="text-[10px] text-slate-400">*Ditambahkan otomatis ke total bayar</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">QRIS Database</h3>
                
                <div class="bg-blue-50 p-2 rounded border border-blue-100 mb-2 text-[10px] text-blue-600">
                    <i class="fas fa-info-circle"></i> Wajib upload gambar QRIS agar pembeli bisa bayar.
                </div>

                <input type="file" id="qrisUpload" accept="image/*" class="hidden">
                <button onclick="document.getElementById('qrisUpload').click()" class="w-full py-3 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold border border-indigo-100 mb-2 hover:bg-indigo-100 transition">
                    <i class="fas fa-camera"></i> Upload Gambar QRIS
                </button>
                <textarea id="setQrisString" class="w-full p-2 text-[10px] bg-slate-100 rounded border font-mono" rows="2" readonly placeholder="String QRIS akan muncul disini..."></textarea>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">Tambah Produk</h3>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="newProdName" class="flex-1 p-2 border rounded-lg text-sm" placeholder="Nama Produk">
                    <input type="number" id="newProdPrice" class="w-24 p-2 border rounded-lg text-sm" placeholder="Harga">
                </div>
                <button onclick="window.addProduct()" class="w-full bg-green-500 text-white py-2 rounded-lg font-bold text-sm mb-4 hover:bg-green-600 transition">Tambah</button>

                <div id="adminProductList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>

            <button onclick="window.saveSettings()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-xl sticky bottom-4 hover:bg-slate-800 transition">SIMPAN SEMUA</button>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIG FIREBASE KAMU (SUDAH DIISI OTOMATIS) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAUL2WkPlJLb8wHcSKQ_QA7GSZ5DGw94Ng",
      authDomain: "kasir-online-c22bd.firebaseapp.com",
      databaseURL: "https://kasir-online-c22bd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kasir-online-c22bd",
      storageBucket: "kasir-online-c22bd.firebasestorage.app",
      messagingSenderId: "1052259146588",
      appId: "1:1052259146588:web:a3f4e9c31982cbfa2dff99",
      measurementId: "G-QR6HPRX459"
    };

    // ID Toko & WA Owner
    const STORE_ID = "toko-utama";
    const OWNER_WA = "6285236363128"; // Sudah disesuaikan

    // Init Toastr
    toastr.options = { "positionClass": "toast-top-center", "timeOut": "2000" };
    
    let db;
    let storeData = { 
        name: "Loading...", 
        fee: 0, 
        qris: "", 
        products: [] 
    };
    let currentTotal = 0;
    let selectedItemName = "";

    // Init App
    try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        
        // Cek koneksi & Load Data
        setTimeout(() => initApp(), 500);
    } catch(e) {
        alert("Firebase Error. Cek console.");
    }

    async function initApp() {
        document.getElementById('loaderIcon').className = "w-2 h-2 rounded-full bg-green-400";
        
        try {
            const snapshot = await get(child(ref(db), `stores/${STORE_ID}`));
            if (snapshot.exists()) {
                storeData = snapshot.val();
                if(!storeData.products) storeData.products = [];
                if(!storeData.fee) storeData.fee = 0;
            } else {
                // Setup default jika kosong
                storeData = { name: "Toko Saya", fee: 0, qris: "", products: [] };
            }
            renderShop();
        } catch(e) {
            toastr.error("Gagal memuat data. Cek internet.");
        }
    }

    // --- RENDER SHOP (PENGUNJUNG) ---
    function renderShop() {
        document.getElementById('shopTitle').innerText = storeData.name || "Toko Online";
        const grid = document.getElementById('productGrid');
        grid.innerHTML = "";

        if(storeData.products && storeData.products.length > 0) {
            storeData.products.forEach((p, index) => {
                grid.innerHTML += `
                <div onclick="window.selectItem(${index})" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm cursor-pointer hover:border-indigo-500 transition active:scale-95">
                    <div class="flex justify-between items-start">
                        <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-tag text-indigo-500"></i>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 text-xs"></i>
                    </div>
                    <h4 class="font-bold text-slate-700 text-sm truncate mb-1">${p.name}</h4>
                    <p class="text-indigo-600 font-bold">Rp ${parseInt(p.price).toLocaleString()}</p>
                </div>`;
            });
        } else {
            grid.innerHTML = `<div class="col-span-2 text-center text-slate-400 py-10 bg-white rounded-xl border border-dashed border-slate-200">
                <i class="fas fa-box-open text-2xl mb-2"></i><br>Belum ada produk.<br>Login Admin (Gembok di atas) untuk tambah.
            </div>`;
        }
    }

    // --- TRANSAKSI ---
    window.selectItem = (index) => {
        const item = storeData.products[index];
        selectedItemName = item.name;
        
        const price = parseInt(item.price);
        const fee = parseInt(storeData.fee || 0);
        currentTotal = price + fee;

        document.getElementById('billItemName').innerText = item.name;
        document.getElementById('billItemPrice').innerText = "Rp " + price.toLocaleString();
        document.getElementById('billFee').innerText = "+ Rp " + fee.toLocaleString();
        document.getElementById('billTotal').innerText = "Rp " + currentTotal.toLocaleString();

        document.getElementById('checkoutArea').classList.remove('hidden');
        document.getElementById('productGrid').classList.add('hidden');
        
        generateQR(currentTotal);
        document.querySelector('.overflow-y-auto').scrollTo(0,0);
    };

    window.resetSelection = () => {
        document.getElementById('checkoutArea').classList.add('hidden');
        document.getElementById('productGrid').classList.remove('hidden');
        document.getElementById('custName').value = "";
        document.getElementById('proofPreview').classList.add('hidden');
        document.getElementById('proofFile').value = "";
        document.getElementById('proofText').innerText = "Pilih Foto Bukti";
    };

    window.previewProof = (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('proofPreview');
                img.src = e.target.result;
                img.classList.remove('hidden');
                document.getElementById('proofText').innerText = "Ganti Foto";
            }
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.processCheckout = () => {
        const name = document.getElementById('custName').value;
        const file = document.getElementById('proofFile').files[0];

        if(!name) return toastr.warning("Isi Nama Anda!");
        if(!file) return toastr.warning("Wajib upload bukti transfer!");

        const msg = `*ORDER BARU DARI WEB*\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüõçÔ∏è Produk: ${selectedItemName}\nüë§ Pembeli: ${name}\nüí∞ Total Transfer: *Rp ${currentTotal.toLocaleString()}*\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n*Bukti Transfer:* (User akan melampirkan gambar)`;

        const url = `https://wa.me/${OWNER_WA}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');

        alert("WhatsApp akan terbuka.\n\nJANGAN LUPA: Paste/Lampirkan foto bukti transfer Anda di chat tersebut.");
        window.resetSelection();
    };

    // --- ADMIN ---
    window.openAdmin = () => {
        document.getElementById('page-shop').classList.add('hidden');
        document.getElementById('page-admin-login').classList.remove('hidden');
    };

    window.closeAdmin = () => {
        document.getElementById('page-admin-login').classList.add('hidden');
        document.getElementById('page-admin-dashboard').classList.add('hidden');
        document.getElementById('page-shop').classList.remove('hidden');
    };

    window.loginAdmin = () => {
        const pin = document.getElementById('adminPin').value;
        if(pin === "110603") {
            document.getElementById('page-admin-login').classList.add('hidden');
            document.getElementById('page-admin-dashboard').classList.remove('hidden');
            loadAdminData();
            document.getElementById('adminPin').value = "";
            toastr.success("Login Berhasil");
        } else {
            toastr.error("PIN Salah!");
        }
    };

    function loadAdminData() {
        document.getElementById('setShopName').value = storeData.name || "";
        document.getElementById('setFee').value = storeData.fee || 0;
        document.getElementById('setQrisString').value = storeData.qris || "";
        renderAdminProducts();
    }

    function renderAdminProducts() {
        const list = document.getElementById('adminProductList');
        list.innerHTML = "";
        storeData.products.forEach((p, i) => {
            list.innerHTML += `
            <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg text-sm border">
                <span class="font-medium">${p.name} - Rp ${parseInt(p.price).toLocaleString()}</span>
                <button onclick="window.deleteProd(${i})" class="text-red-500 font-bold bg-white px-2 py-1 rounded shadow-sm hover:bg-red-50">Hapus</button>
            </div>`;
        });
    }

    // --- UPLOAD QRIS (ADMIN) ---
    document.getElementById('qrisUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        toastr.info("Memproses QRIS...");
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement("canvas");
                cvs.width = img.width; cvs.height = img.height;
                const ctx = cvs.getContext("2d");
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0,0,cvs.width,cvs.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if(code) {
                    document.getElementById('setQrisString').value = code.data;
                    toastr.success("QRIS Berhasil Dibaca!");
                } else {
                    toastr.error("QRIS tidak terbaca. Pastikan gambar jelas/crop.");
                }
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    });

    window.saveSettings = async () => {
        storeData.name = document.getElementById('setShopName').value;
        storeData.fee = parseInt(document.getElementById('setFee').value) || 0;
        storeData.qris = document.getElementById('setQrisString').value;
        
        const btn = document.querySelector('button[onclick="window.saveSettings()"]');
        btn.innerText = "Menyimpan...";
        btn.disabled = true;

        try {
            await set(ref(db, `stores/${STORE_ID}`), storeData);
            toastr.success("Berhasil Disimpan!");
            window.closeAdmin();
            renderShop();
        } catch(e) {
            toastr.error("Gagal simpan.");
        }
        btn.innerText = "SIMPAN SEMUA";
        btn.disabled = false;
    };

    window.addProduct = () => {
        const name = document.getElementById('newProdName').value;
        const price = document.getElementById('newProdPrice').value;
        if(!name || !price) return toastr.warning("Lengkapi data produk");

        storeData.products.push({name, price: parseInt(price)});
        renderAdminProducts();
        document.getElementById('newProdName').value = "";
        document.getElementById('newProdPrice').value = "";
    };

    window.deleteProd = (i) => {
        if(confirm("Hapus?")) {
            storeData.products.splice(i, 1);
            renderAdminProducts();
        }
    };

    // --- QR GENERATOR ---
    function generateQR(amount) {
        const container = document.getElementById('qrContainer');
        container.innerHTML = "";
        
        let finalString = storeData.qris;
        if(!finalString) {
            container.innerHTML = `<span class="text-xs text-red-400 font-bold">‚ö†Ô∏è QRIS Belum diupload Admin</span>`;
            return;
        }

        if(amount > 0) {
            try { finalString = injectAmount(finalString, amount); } catch(e) {}
        }

        new QRCode(container, {
            text: finalString,
            width: 180,
            height: 180,
            colorDark : "#1e293b",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.M
        });
    }

    function injectAmount(payload, amount) {
        let p = payload.slice(0, -4);
        p = p.replace("010211", "010212");
        const amStr = amount + ".00";
        const tag54 = "54" + amStr.length.toString().padStart(2,'0') + amStr;
        
        if(p.includes("5802ID")) {
            const idx = p.indexOf("5802ID");
            p = p.slice(0, idx) + tag54 + p.slice(idx);
        } else {
            p = p + tag54;
        }
        return p + crc16(p);
    }

    function crc16(s) {
        let crc = 0xFFFF;
        for (let i = 0; i < s.length; i++) {
            crc ^= s.charCodeAt(i) << 8;
            for (let j = 0; j < 8; j++) {
                crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1;
                crc = crc & 0xFFFF;
            }
        }
        return crc.toString(16).toUpperCase().padStart(4, '0');
    }

    // Expose Global
    window.selectItem = window.selectItem;
    window.resetSelection = window.resetSelection;
    window.previewProof = window.previewProof;
    window.processCheckout = window.processCheckout;
    window.openAdmin = window.openAdmin;
    window.closeAdmin = window.closeAdmin;
    window.loginAdmin = window.loginAdmin;
    window.saveSettings = window.saveSettings;
    window.addProduct = window.addProduct;
    window.deleteProd = window.deleteProd;

  </script>
</body>
</html>
