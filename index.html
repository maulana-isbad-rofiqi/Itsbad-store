<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itsbad Store - Toko Online</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõçÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="flex justify-center min-h-screen text-gray-800">

<div class="w-full max-w-md bg-white shadow-xl min-h-screen relative flex flex-col">

    <!-- NAVBAR -->
    <nav class="glass-nav p-4 sticky top-0 z-50 flex justify-between items-center border-b">
        <div class="flex items-center gap-3">
            <div onclick="showProfile()" class="cursor-pointer">
                <div id="userAvatar" class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center overflow-hidden">
                    <i class="fas fa-user text-indigo-500"></i>
                </div>
            </div>
            <div>
                <h1 class="font-bold text-gray-800" id="shopNameDisplay">Itsbad Store</h1>
                <p class="text-xs text-gray-500" id="userNameDisplay">Silakan login</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="toggleCart()" class="relative p-2">
                <i class="fas fa-shopping-cart text-xl text-gray-600"></i>
                <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
            </button>
        </div>
    </nav>

    <!-- AUTH OVERLAY -->
    <div id="authOverlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-store text-3xl text-indigo-600"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Itsbad Store</h2>
            <p class="text-gray-600">Toko Online Professional</p>
        </div>
        
        <button onclick="loginGoogle()" class="w-full max-w-sm bg-white border border-gray-300 py-3 rounded-lg font-medium flex items-center justify-center gap-3 mb-3 hover:bg-gray-50">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
            Login dengan Google
        </button>
        
        <button onclick="loginGuest()" class="w-full max-w-sm bg-gray-100 py-3 rounded-lg font-medium hover:bg-gray-200">
            Masuk sebagai Tamu
        </button>
        
        <p class="text-xs text-gray-400 mt-6 text-center">
            Login untuk menyimpan profil dan riwayat belanja
        </p>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto no-scrollbar">
        <!-- Hero Section -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
            <h2 class="text-xl font-bold mb-2">Selamat Datang!</h2>
            <p class="text-sm opacity-90">Temukan produk terbaik dengan harga spesial</p>
        </div>

        <!-- Products Section -->
        <div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Produk Tersedia</h3>
                <span class="text-sm text-gray-500" id="productCount">0 produk</span>
            </div>
            
            <div id="productGrid" class="grid grid-cols-2 gap-4">
                <!-- Products will be loaded here -->
            </div>
            
            <!-- Empty State -->
            <div id="emptyProducts" class="text-center py-12 hidden">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-box-open text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-500 font-medium">Belum ada produk</p>
                <p class="text-sm text-gray-400 mt-1">Admin akan menambahkan produk segera</p>
            </div>
        </div>
    </main>

    <!-- CART MODAL -->
    <div id="cartModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50" onclick="toggleCart()"></div>
        <div class="absolute bottom-0 left-0 w-full bg-white rounded-t-2xl shadow-2xl max-h-[80vh] flex flex-col transform translate-y-full transition-transform duration-300">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg">Keranjang Belanja</h3>
                <button onclick="toggleCart()" class="text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Cart items will be loaded here -->
            </div>
            
            <div class="p-4 border-t bg-gray-50">
                <div class="space-y-2 mb-4">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span class="font-bold" id="cartSubtotal">Rp 0</span>
                    </div>
                    <div class="flex justify-between text-orange-600">
                        <span>Biaya Layanan</span>
                        <span id="cartFee">Rp 0</span>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="font-bold">Total</span>
                    <span class="text-xl font-bold text-indigo-600" id="cartTotal">Rp 0</span>
                </div>
                <button onclick="processCheckout()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">
                    LANJUT PEMBAYARAN
                </button>
            </div>
        </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkoutModal" class="fixed inset-0 bg-white z-50 hidden flex-col">
        <div class="p-4 border-b flex items-center gap-3">
            <button onclick="closeCheckout()" class="text-gray-500">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="font-bold text-lg">Pembayaran</h2>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5">
            <!-- Order Summary -->
            <div class="bg-indigo-50 p-4 rounded-xl mb-6">
                <p class="text-sm text-indigo-600 font-medium mb-1">Total Pembayaran</p>
                <h1 class="text-3xl font-bold text-indigo-700" id="checkoutTotal">Rp 0</h1>
            </div>
            
            <!-- QRIS Section -->
            <div class="bg-white border rounded-xl p-4 mb-6">
                <p class="text-sm font-medium text-gray-700 mb-3">Scan QRIS untuk Bayar</p>
                <div id="qrContainer" class="flex justify-center min-h-[200px] items-center">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-qrcode text-gray-400 text-2xl"></i>
                        </div>
                        <p class="text-sm text-gray-500">QRIS akan muncul di sini</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-3 text-center">
                    Nominal sudah termasuk biaya layanan
                </p>
            </div>
            
            <!-- Instructions -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                <h4 class="font-bold text-yellow-800 mb-2">üìã Instruksi Pembayaran</h4>
                <ol class="text-sm text-yellow-800 space-y-2 list-decimal pl-4">
                    <li>Scan QR Code dengan aplikasi bank/e-wallet</li>
                    <li>Pastikan nominal sesuai</li>
                    <li><strong>Screenshot bukti transfer!</strong></li>
                    <li>Kirim screenshot ke WhatsApp admin</li>
                </ol>
            </div>
            
            <!-- Customer Info -->
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-bold text-gray-700 mb-3">Data Pemesan</h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Nama Lengkap</label>
                        <input type="text" id="checkoutName" class="w-full p-3 border rounded-lg bg-white" readonly>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Nomor WhatsApp</label>
                        <input type="text" id="checkoutPhone" class="w-full p-3 border rounded-lg bg-white" readonly>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t">
            <button onclick="sendToWhatsApp()" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-green-600">
                <i class="fab fa-whatsapp"></i>
                KIRIM KE WHATSAPP
            </button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profileModal" class="fixed inset-0 bg-white z-50 hidden flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h2 class="font-bold text-lg">Profil Saya</h2>
            <button onclick="closeProfile()" class="text-gray-500">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5">
            <div class="text-center mb-6">
                <div id="profileAvatar" class="w-24 h-24 rounded-full bg-indigo-100 mx-auto mb-4 flex items-center justify-center overflow-hidden">
                    <i class="fas fa-user text-3xl text-indigo-500"></i>
                </div>
                <h3 class="font-bold text-xl" id="profileName">-</h3>
                <p class="text-gray-500 text-sm" id="profileEmail">-</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Informasi Pribadi</label>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Nama Lengkap</label>
                            <input type="text" id="editName" class="w-full p-3 border rounded-lg" placeholder="Nama Anda">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Nomor WhatsApp</label>
                            <div class="flex gap-2">
                                <div class="flex items-center px-3 bg-gray-100 border rounded-lg">
                                    <span class="text-gray-600">+62</span>
                                </div>
                                <input type="tel" id="editPhone" class="flex-1 p-3 border rounded-lg" placeholder="8123456789">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Alamat</label>
                            <textarea id="editAddress" class="w-full p-3 border rounded-lg" rows="3" placeholder="Alamat lengkap"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t space-y-3">
            <button onclick="saveProfile()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">
                SIMPAN PROFIL
            </button>
            <button onclick="logout()" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200">
                KELUAR
            </button>
        </div>
    </div>

    <!-- PRODUCT DETAIL MODAL -->
    <div id="productDetailModal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto slide-up">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="font-bold text-lg">Detail Produk</h2>
                <button onclick="closeProductDetail()" class="text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-5">
                <div class="w-full h-48 bg-indigo-50 rounded-xl mb-4 flex items-center justify-center">
                    <i class="fas fa-box text-5xl text-indigo-300"></i>
                </div>
                
                <h1 id="detailName" class="text-2xl font-bold mb-2">Nama Produk</h1>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p id="detailPrice" class="text-3xl font-bold text-indigo-600">Rp 0</p>
                        <p id="detailStock" class="text-sm text-gray-500">Stok: 0</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">Deskripsi</h4>
                    <p id="detailDescription" class="text-gray-600">-</p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="closeProductDetail()" class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg font-medium">
                        KEMBALI
                    </button>
                    <button id="detailAddToCart" onclick="addToCartFromDetail()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700">
                        TAMBAH KE KERANJANG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL (Hidden - Access via /?page=admin) -->
    <div id="adminPanel" class="fixed inset-0 bg-white z-50 hidden flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h2 class="font-bold text-lg">Admin Panel</h2>
            <button onclick="closeAdmin()" class="text-red-500 font-medium">
                TUTUP
            </button>
        </div>
        
        <!-- Admin Login -->
        <div id="adminLogin" class="p-8 text-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-lock text-2xl text-gray-500"></i>
            </div>
            <h3 class="font-bold text-xl mb-2">Akses Admin</h3>
            <p class="text-gray-600 mb-6">Masukkan PIN untuk melanjutkan</p>
            <input type="password" id="adminPin" class="w-full p-4 text-center text-xl border rounded-xl mb-4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6">
            <button onclick="verifyAdmin()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-gray-900">
                MASUK
            </button>
        </div>
        
        <!-- Admin Content -->
        <div id="adminContent" class="hidden flex-1 overflow-y-auto">
            <div class="p-4 space-y-6">
                <!-- Store Settings -->
                <div class="bg-white border rounded-xl p-4">
                    <h3 class="font-bold text-gray-700 mb-3">Pengaturan Toko</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-600 mb-1 block">Nama Toko</label>
                            <input type="text" id="storeName" class="w-full p-3 border rounded-lg" placeholder="Nama toko Anda">
                        </div>
                        <div>
                            <label class="text-sm text-gray-600 mb-1 block">Biaya Layanan (Rp)</label>
                            <input type="number" id="storeFee" class="w-full p-3 border rounded-lg" placeholder="0">
                        </div>
                        <div>
                            <label class="text-sm text-gray-600 mb-1 block">QRIS (String QR Code)</label>
                            <textarea id="storeQRIS" class="w-full p-3 border rounded-lg text-xs font-mono" rows="3" placeholder="Tempel string QRIS di sini"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Gunakan QRIS dari bank/e-wallet merchant Anda</p>
                        </div>
                        <button onclick="saveStoreSettings()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">
                            SIMPAN PENGATURAN
                        </button>
                    </div>
                </div>
                
                <!-- Add Product -->
                <div class="bg-white border rounded-xl p-4">
                    <h3 class="font-bold text-gray-700 mb-3">Tambah Produk</h3>
                    <div class="space-y-3">
                        <input type="text" id="newProductName" class="w-full p-3 border rounded-lg" placeholder="Nama Produk">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="newProductPrice" class="p-3 border rounded-lg" placeholder="Harga">
                            <input type="number" id="newProductStock" class="p-3 border rounded-lg" placeholder="Stok">
                        </div>
                        <textarea id="newProductDesc" class="w-full p-3 border rounded-lg" rows="2" placeholder="Deskripsi produk"></textarea>
                        <button onclick="addNewProduct()" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">
                            TAMBAH PRODUK
                        </button>
                    </div>
                </div>
                
                <!-- Product List -->
                <div class="bg-white border rounded-xl p-4">
                    <h3 class="font-bold text-gray-700 mb-3">Daftar Produk</h3>
                    <div id="adminProductList" class="space-y-2">
                        <!-- Products will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase Configuration - GANTI DENGAN MILIK ANDA
    const firebaseConfig = {
        apiKey: "AIzaSyAUL2WkPlJLb8wHcSKQ_QA7GSZ5DGw94Ng",
        authDomain: "kasir-online-c22bd.firebaseapp.com",
        databaseURL: "https://kasir-online-c22bd-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kasir-online-c22bd",
        storageBucket: "kasir-online-c22bd.firebasestorage.app",
        messagingSenderId: "1052259146588",
        appId: "1:1052259146588:web:a3f4e9c31982cbfa2dff99",
        measurementId: "G-QR6HPRX459"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Global variables
    const STORE_ID = "itsbad-store";
    const OWNER_WA = "6285236363128"; // Ganti dengan nomor WhatsApp Anda
    const ADMIN_PIN = "110603"; // PIN untuk akses admin
    
    let currentUser = null;
    let storeData = { name: "Itsbad Store", fee: 0, qris: "", products: [] };
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {};
    let currentProductIndex = null;

    // Toastr configuration
    toastr.options = {
        positionClass: 'toast-top-center',
        timeOut: 3000,
        closeButton: true
    };

    // Check for admin access
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('page') === 'admin') {
        setTimeout(() => {
            document.getElementById('adminPanel').classList.remove('hidden');
        }, 1000);
    }

    // Auth State Listener
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('authOverlay').classList.add('hidden');
            
            // Load or create user profile
            loadUserProfile(user.uid);
            
            // Update UI
            updateUserDisplay();
            
            // Load store data
            loadStoreData();
        } else {
            document.getElementById('authOverlay').classList.remove('hidden');
        }
    });

    // Authentication functions
    window.loginGoogle = async () => {
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
            toastr.success('Login berhasil!');
        } catch (error) {
            toastr.error('Login gagal: ' + error.message);
        }
    };

    window.loginGuest = async () => {
        try {
            await signInAnonymously(auth);
            toastr.success('Masuk sebagai tamu');
        } catch (error) {
            toastr.error('Login gagal: ' + error.message);
        }
    };

    window.logout = async () => {
        try {
            await signOut(auth);
            localStorage.removeItem('userProfile');
            userProfile = {};
            cart = [];
            saveCart();
            toastr.info('Anda telah logout');
        } catch (error) {
            toastr.error('Logout gagal');
        }
    };

    // User Profile functions
    async function loadUserProfile(uid) {
        try {
            const userRef = ref(db, 'users/' + uid);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                userProfile = snapshot.val();
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
            } else {
                // Create new profile
                userProfile = {
                    name: currentUser.displayName || 'Customer',
                    email: currentUser.email || '',
                    phone: '',
                    address: '',
                    createdAt: Date.now()
                };
                await set(userRef, userProfile);
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
            }
        } catch (error) {
            console.error('Error loading profile:', error);
        }
    }

    function updateUserDisplay() {
        document.getElementById('userNameDisplay').textContent = userProfile.name || 'Customer';
        document.getElementById('profileName').textContent = userProfile.name || 'Customer';
        document.getElementById('profileEmail').textContent = userProfile.email || '';
        document.getElementById('editName').value = userProfile.name || '';
        document.getElementById('editPhone').value = userProfile.phone || '';
        document.getElementById('editAddress').value = userProfile.address || '';
        
        // Update avatar if exists
        if (currentUser.photoURL) {
            document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.photoURL}" class="w-full h-full object-cover">`;
            document.getElementById('profileAvatar').innerHTML = `<img src="${currentUser.photoURL}" class="w-full h-full object-cover">`;
        }
    }

    window.saveProfile = async () => {
        const name = document.getElementById('editName').value.trim();
        const phone = document.getElementById('editPhone').value.trim();
        const address = document.getElementById('editAddress').value.trim();
        
        if (!name) {
            toastr.warning('Nama tidak boleh kosong');
            return;
        }
        
        userProfile.name = name;
        userProfile.phone = phone;
        userProfile.address = address;
        
        try {
            await update(ref(db, 'users/' + currentUser.uid), {
                name: name,
                phone: phone,
                address: address,
                updatedAt: Date.now()
            });
            
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateUserDisplay();
            toastr.success('Profil berhasil disimpan');
            closeProfile();
        } catch (error) {
            toastr.error('Gagal menyimpan profil');
        }
    };

    window.showProfile = () => {
        document.getElementById('profileModal').classList.remove('hidden');
    };

    window.closeProfile = () => {
        document.getElementById('profileModal').classList.add('hidden');
    };

    // Store functions
    async function loadStoreData() {
        try {
            const storeRef = ref(db, 'stores/' + STORE_ID);
            const snapshot = await get(storeRef);
            
            if (snapshot.exists()) {
                storeData = snapshot.val();
                if (!storeData.products) storeData.products = [];
            } else {
                // Create new store
                storeData = {
                    name: 'Itsbad Store',
                    fee: 0,
                    qris: '',
                    products: [],
                    createdAt: Date.now()
                };
                await set(storeRef, storeData);
            }
            
            renderProducts();
            updateCartBadge();
        } catch (error) {
            console.error('Error loading store:', error);
            renderProducts();
        }
    }

    function renderProducts() {
        const productGrid = document.getElementById('productGrid');
        const emptyState = document.getElementById('emptyProducts');
        const productCount = document.getElementById('productCount');
        
        if (storeData.products && storeData.products.length > 0) {
            productGrid.innerHTML = '';
            productCount.textContent = storeData.products.length + ' produk';
            emptyState.classList.add('hidden');
            
            storeData.products.forEach((product, index) => {
                const hasStock = product.stock > 0;
                const productCard = `
                    <div class="bg-white border rounded-xl overflow-hidden slide-up">
                        <div onclick="showProductDetail(${index})" class="cursor-pointer">
                            <div class="h-32 bg-gray-100 flex items-center justify-center">
                                <i class="fas fa-box text-3xl text-gray-400"></i>
                            </div>
                            <div class="p-3">
                                <h4 class="font-medium text-gray-800 truncate">${product.name}</h4>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="font-bold text-indigo-600">Rp ${product.price.toLocaleString()}</span>
                                    <span class="text-xs text-gray-500">Stok: ${product.stock}</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 pt-0">
                            <button onclick="event.stopPropagation(); addToCart(${index})" 
                                    class="w-full bg-gray-800 text-white py-2 text-sm rounded-lg hover:bg-gray-900 ${!hasStock ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${!hasStock ? 'disabled' : ''}>
                                ${hasStock ? 'Tambah ke Keranjang' : 'Stok Habis'}
                            </button>
                        </div>
                    </div>
                `;
                productGrid.innerHTML += productCard;
            });
        } else {
            productGrid.innerHTML = '';
            productCount.textContent = '0 produk';
            emptyState.classList.remove('hidden');
        }
        
        document.getElementById('shopNameDisplay').textContent = storeData.name;
    }

    // Product Detail functions
    window.showProductDetail = (index) => {
        currentProductIndex = index;
        const product = storeData.products[index];
        
        document.getElementById('detailName').textContent = product.name;
        document.getElementById('detailPrice').textContent = 'Rp ' + product.price.toLocaleString();
        document.getElementById('detailStock').textContent = 'Stok: ' + product.stock;
        document.getElementById('detailDescription').textContent = product.desc || 'Tidak ada deskripsi';
        
        const addBtn = document.getElementById('detailAddToCart');
        if (product.stock > 0) {
            addBtn.disabled = false;
            addBtn.textContent = 'TAMBAH KE KERANJANG';
            addBtn.className = 'flex-1 bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700';
        } else {
            addBtn.disabled = true;
            addBtn.textContent = 'STOK HABIS';
            addBtn.className = 'flex-1 bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed';
        }
        
        document.getElementById('productDetailModal').classList.remove('hidden');
    };

    window.closeProductDetail = () => {
        document.getElementById('productDetailModal').classList.add('hidden');
    };

    window.addToCartFromDetail = () => {
        if (currentProductIndex !== null) {
            addToCart(currentProductIndex);
            closeProductDetail();
        }
    };

    // Cart functions
    window.addToCart = (index) => {
        const product = storeData.products[index];
        
        if (product.stock <= 0) {
            toastr.warning('Stok produk habis');
            return;
        }
        
        const existingItem = cart.find(item => item.index === index);
        
        if (existingItem) {
            if (existingItem.quantity < product.stock) {
                existingItem.quantity++;
                toastr.success(`${product.name} (${existingItem.quantity})`);
            } else {
                toastr.warning('Stok maksimal tercapai');
            }
        } else {
            cart.push({
                index: index,
                name: product.name,
                price: product.price,
                quantity: 1,
                maxStock: product.stock
            });
            toastr.success('Ditambahkan ke keranjang');
        }
        
        saveCart();
    };

    window.updateQty = (cartIndex, change) => {
        const item = cart[cartIndex];
        const newQty = item.quantity + change;
        
        if (newQty > 0 && newQty <= item.maxStock) {
            item.quantity = newQty;
        } else if (newQty <= 0) {
            if (confirm('Hapus item dari keranjang?')) {
                cart.splice(cartIndex, 1);
                toastr.info('Item dihapus');
            }
        } else {
            toastr.warning('Stok tidak mencukupi');
        }
        
        saveCart();
    };

    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartBadge();
        renderCart();
    }

    function updateCartBadge() {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const badge = document.getElementById('cartCount');
        
        if (totalItems > 0) {
            badge.textContent = totalItems;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    window.toggleCart = () => {
        const modal = document.getElementById('cartModal');
        const sheet = modal.querySelector('div > div');
        
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                sheet.classList.remove('translate-y-full');
            }, 10);
        } else {
            sheet.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
    };

    function renderCart() {
        const container = document.getElementById('cartItems');
        
        if (cart.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-shopping-cart text-3xl mb-3"></i>
                    <p>Keranjang kosong</p>
                </div>`;
        } else {
            let html = '';
            cart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                html += `
                    <div class="flex items-center justify-between bg-white p-3 border rounded-lg">
                        <div class="flex-1">
                            <h5 class="font-medium">${item.name}</h5>
                            <p class="text-sm text-indigo-600 font-bold">Rp ${item.price.toLocaleString()}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="updateQty(${index}, -1)" class="w-8 h-8 flex items-center justify-center border rounded">-</button>
                            <span class="w-8 text-center">${item.quantity}</span>
                            <button onclick="updateQty(${index}, 1)" class="w-8 h-8 flex items-center justify-center border rounded">+</button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }
        
        // Update totals
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const fee = storeData.fee || 0;
        const total = subtotal + fee;
        
        document.getElementById('cartSubtotal').textContent = 'Rp ' + subtotal.toLocaleString();
        document.getElementById('cartFee').textContent = 'Rp ' + fee.toLocaleString();
        document.getElementById('cartTotal').textContent = 'Rp ' + total.toLocaleString();
    }

    // Checkout functions
    window.processCheckout = () => {
        if (cart.length === 0) {
            toastr.warning('Keranjang kosong');
            return;
        }
        
        if (!userProfile.phone || userProfile.phone.length < 9) {
            toastr.warning('Lengkapi nomor WhatsApp di profil');
            showProfile();
            toggleCart();
            return;
        }
        
        // Calculate totals
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const fee = storeData.fee || 0;
        const total = subtotal + fee;
        
        // Update UI
        document.getElementById('checkoutTotal').textContent = 'Rp ' + total.toLocaleString();
        document.getElementById('checkoutName').value = userProfile.name || 'Customer';
        document.getElementById('checkoutPhone').value = userProfile.phone ? '+62' + userProfile.phone : '-';
        
        // Generate QR Code
        generateQRCode(total);
        
        // Show modal
        toggleCart();
        document.getElementById('checkoutModal').classList.remove('hidden');
    };

    window.closeCheckout = () => {
        document.getElementById('checkoutModal').classList.add('hidden');
    };

    function generateQRCode(amount) {
        const container = document.getElementById('qrContainer');
        container.innerHTML = '';
        
        if (!storeData.qris) {
            container.innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-exclamation-triangle text-gray-400"></i>
                    </div>
                    <p class="text-sm text-gray-600">QRIS belum diatur</p>
                    <p class="text-xs text-gray-500">Admin perlu mengatur QRIS</p>
                </div>`;
            return;
        }
        
        // Generate QR Code
        try {
            new QRCode(container, {
                text: storeData.qris,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        } catch (error) {
            container.innerHTML = '<p class="text-red-500 text-sm">Error generating QR</p>';
        }
    }

    window.sendToWhatsApp = () => {
        if (cart.length === 0) return;
        
        if (!confirm('Pastikan Anda sudah:\n1. Melakukan transfer\n2. Menyimpan screenshot bukti\n\nLanjutkan ke WhatsApp?')) {
            return;
        }
        
        // Build order summary
        let itemsText = '';
        cart.forEach(item => {
            itemsText += `‚Ä¢ ${item.name} (${item.quantity}x) = Rp ${(item.price * item.quantity).toLocaleString()}\n`;
        });
        
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const fee = storeData.fee || 0;
        const total = subtotal + fee;
        const dateTime = new Date().toLocaleString('id-ID');
        
        const message = `*ORDER BARU - ${storeData.name}*
=========================
*DATA PEMBELI*
Nama: ${userProfile.name}
WhatsApp: +62${userProfile.phone}
Alamat: ${userProfile.address}

*DETAIL PESANAN*
${itemsText}
=========================
Subtotal: Rp ${subtotal.toLocaleString()}
Biaya Layanan: Rp ${fee.toLocaleString()}
*TOTAL: Rp ${total.toLocaleString()}*
=========================
Waktu: ${dateTime}
Status: Menunggu Konfirmasi

*üì∏ Mohon kirim screenshot bukti transfer sebagai balasan pesan ini.*`;
        
        // Save order to database
        saveOrderToDatabase(total, message);
        
        // Open WhatsApp
        const encodedMessage = encodeURIComponent(message);
        window.open(`https://wa.me/${OWNER_WA}?text=${encodedMessage}`, '_blank');
        
        // Clear cart and close
        cart = [];
        saveCart();
        closeCheckout();
        toastr.success('Pesanan berhasil dikirim!');
    };

    async function saveOrderToDatabase(total, message) {
        try {
            const orderData = {
                userId: currentUser.uid,
                userName: userProfile.name,
                userPhone: userProfile.phone,
                items: cart.map(item => `${item.name} (${item.quantity}x)`).join(', '),
                total: total,
                status: 'pending',
                timestamp: Date.now(),
                date: new Date().toISOString()
            };
            
            await push(ref(db, 'orders/' + currentUser.uid), orderData);
        } catch (error) {
            console.error('Error saving order:', error);
        }
    }

    // Admin functions
    window.verifyAdmin = () => {
        const pin = document.getElementById('adminPin').value;
        
        if (pin === ADMIN_PIN) {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminContent').classList.remove('hidden');
            
            // Load admin data
            document.getElementById('storeName').value = storeData.name;
            document.getElementById('storeFee').value = storeData.fee || 0;
            document.getElementById('storeQRIS').value = storeData.qris || '';
            
            renderAdminProducts();
        } else {
            toastr.error('PIN salah');
        }
    };

    window.closeAdmin = () => {
        document.getElementById('adminPanel').classList.add('hidden');
    };

    window.saveStoreSettings = async () => {
        const name = document.getElementById('storeName').value.trim();
        const fee = parseInt(document.getElementById('storeFee').value) || 0;
        const qris = document.getElementById('storeQRIS').value.trim();
        
        if (!name) {
            toastr.warning('Nama toko tidak boleh kosong');
            return;
        }
        
        try {
            await update(ref(db, 'stores/' + STORE_ID), {
                name: name,
                fee: fee,
                qris: qris,
                updatedAt: Date.now()
            });
            
            storeData.name = name;
            storeData.fee = fee;
            storeData.qris = qris;
            
            renderProducts();
            toastr.success('Pengaturan disimpan');
        } catch (error) {
            toastr.error('Gagal menyimpan pengaturan');
        }
    };

    window.addNewProduct = async () => {
        const name = document.getElementById('newProductName').value.trim();
        const price = parseInt(document.getElementById('newProductPrice').value);
        const stock = parseInt(document.getElementById('newProductStock').value);
        const desc = document.getElementById('newProductDesc').value.trim();
        
        if (!name || !price) {
            toastr.warning('Nama dan harga harus diisi');
            return;
        }
        
        if (price < 0 || stock < 0) {
            toastr.warning('Harga dan stok tidak valid');
            return;
        }
        
        const newProduct = {
            name: name,
            price: price,
            stock: stock || 0,
            desc: desc,
            createdAt: Date.now()
        };
        
        try {
            if (!storeData.products) storeData.products = [];
            storeData.products.push(newProduct);
            
            await update(ref(db, 'stores/' + STORE_ID), {
                products: storeData.products
            });
            
            // Clear form
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
            document.getElementById('newProductStock').value = '';
            document.getElementById('newProductDesc').value = '';
            
            renderProducts();
            renderAdminProducts();
            toastr.success('Produk berhasil ditambahkan');
        } catch (error) {
            toastr.error('Gagal menambah produk');
        }
    };

    function renderAdminProducts() {
        const container = document.getElementById('adminProductList');
        
        if (storeData.products && storeData.products.length > 0) {
            let html = '';
            storeData.products.forEach((product, index) => {
                html += `
                    <div class="flex justify-between items-center p-3 border rounded-lg">
                        <div class="flex-1">
                            <h5 class="font-medium">${product.name}</h5>
                            <p class="text-sm text-gray-600">Rp ${product.price.toLocaleString()} ‚Ä¢ Stok: ${product.stock}</p>
                        </div>
                        <button onclick="deleteProduct(${index})" class="text-red-500 hover:text-red-700 ml-3">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada produk</p>';
        }
    }

    window.deleteProduct = async (index) => {
        if (!confirm('Hapus produk ini?')) return;
        
        try {
            storeData.products.splice(index, 1);
            
            await update(ref(db, 'stores/' + STORE_ID), {
                products: storeData.products
            });
            
            renderProducts();
            renderAdminProducts();
            toastr.success('Produk dihapus');
        } catch (error) {
            toastr.error('Gagal menghapus produk');
        }
    };

    // Initialize
    updateCartBadge();

</script>
</body>
</html>
