<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Itsbad Store</title>
  
  <link rel="icon" href="icon.png" type="image/png">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
    .app-container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); padding-bottom: 90px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 12px 0; z-index: 50; }
    .nav-item { color: #94a3b8; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; transition: 0.2s; }
    .nav-item.active { color: #3b82f6; font-weight: 600; }
    .nav-item i { font-size: 20px; }
    .receipt-paper { background: #fff; position: relative; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
    .receipt-paper::after { content: ""; position: absolute; bottom: -6px; left: 0; right: 0; height: 6px; background: radial-gradient(circle, transparent 70%, #fff 75%) 0 0; background-size: 10px 10px; background-position: 0 100%; }
    .card-product:active { transform: scale(0.97); transition: 0.1s; }
    .btn-checkout:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-checkout:not(:disabled):hover { background-color: #1e293b; transform: translateY(-1px); }
    #loginModal { transition: all 0.3s ease !important; display: flex !important; opacity: 1 !important; visibility: visible !important; z-index: 9999 !important; }
    #loginModal.hidden { display: none !important; opacity: 0 !important; visibility: hidden !important; }
    .login-option { transition: all 0.2s ease; border: 1px solid #e2e8f0; }
    .login-option:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .guest-warning { animation: pulse 2s infinite; background-color: #fffbeb; border: 1px solid #fde68a; border-radius: 12px; }
    
    /* Style untuk Aplikasi */
    .app-item { transition: all 0.2s; }
    .app-item:active { transform: scale(0.98); background-color: #f1f5f9; }
    
    /* Coupon Styles */
    .coupon-badge { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-weight: bold; }
    .coupon-expired { opacity: 0.6; filter: grayscale(0.8); }
    
    /* Payment Method Styles */
    .payment-method { border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; transition: all 0.2s; }
    .payment-method.active { border-color: #3b82f6; background-color: #eff6ff; }
    .payment-method:hover { border-color: #94a3b8; }
    
    /* Admin Panel Improvements */
    .admin-tab { padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; transition: all 0.2s; }
    .admin-tab.active { background: #3b82f6; color: white; }
    .admin-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
    .admin-section-title { font-size: 13px; font-weight: 700; color: #4b5563; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
    
    /* Animations */
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .slide-up { animation: slideUp 0.3s ease; }
    .slide-down { animation: slideDown 0.3s ease; }
    .fade-in { animation: fadeIn 0.3s ease; }
    
    /* Loading Animation */
    .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Empty State */
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; }
    .empty-state i { font-size: 48px; color: #cbd5e1; margin-bottom: 16px; }
    .empty-state h3 { font-size: 16px; font-weight: 600; color: #64748b; margin-bottom: 8px; }
    .empty-state p { font-size: 14px; color: #94a3b8; max-width: 300px; }
    
    /* Product Card Improvements */
    .product-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 16px; overflow: hidden; }
    .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
    
    /* Button Improvements */
    .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; font-weight: 600; border: none; border-radius: 12px; padding: 14px 24px; transition: all 0.2s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }
    .btn-primary:active { transform: translateY(0); }
    
    /* Input Improvements */
    .input-field { border: 2px solid #e2e8f0; border-radius: 12px; padding: 14px 16px; font-size: 14px; transition: all 0.2s; }
    .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
    
    /* Badge */
    .badge { display: inline-flex; align-items: center; justify-content: center; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-success { background-color: #10b981; color: white; }
    .badge-warning { background-color: #f59e0b; color: white; }
    .badge-danger { background-color: #ef4444; color: white; }
    .badge-info { background-color: #3b82f6; color: white; }
    
    /* Toast Customization */
    .toast-success { background-color: #10b981 !important; }
    .toast-error { background-color: #ef4444 !important; }
    .toast-info { background-color: #3b82f6 !important; }
    .toast-warning { background-color: #f59e0b !important; }
    
    @keyframes pulse { 0% { opacity: 0.9; } 50% { opacity: 1; } 100% { opacity: 0.9; } }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">

  <!-- Loading Screen -->
  <div id="loadingScreen" class="fixed inset-0 z-[999] bg-white flex flex-col items-center justify-center">
    <div class="loading-spinner mb-4"></div>
    <p class="text-sm text-slate-600">Memuat...</p>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center p-5">
    <div class="text-center mb-8">
      <div class="w-24 h-24 mx-auto mb-4 rounded-2xl bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-center">
        <i class="fas fa-store text-white text-3xl"></i>
      </div>
      <h1 class="text-2xl font-bold text-slate-800 mb-2">Selamat Datang</h1>
      <p class="text-sm text-slate-500">Itsbad Store - Premium Digital Services</p>
    </div>
    <div class="w-full max-w-xs space-y-4">
      <button id="googleLoginBtn" onclick="window.loginWithGoogle()" class="login-option w-full bg-white border border-slate-200 py-3.5 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-slate-50">
        <i class="fab fa-google text-red-500 text-lg"></i><span>Login dengan Google</span>
      </button>
      <button id="guestLoginBtn" onclick="window.continueAsGuest()" class="login-option w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-slate-800">
        <i class="fas fa-user-clock text-lg"></i><span>Lanjut sebagai Tamu</span>
      </button>
      <div class="guest-warning p-3 mt-4">
        <div class="flex items-start gap-2">
          <i class="fas fa-exclamation-circle text-orange-500 mt-0.5"></i>
          <div class="text-left"><h4 class="font-bold text-xs text-orange-700">Mode Tamu</h4><p class="text-[10px] text-orange-600">Riwayat pesanan tidak akan tersimpan.</p></div>
        </div>
      </div>
    </div>
    <div class="absolute bottom-6 left-0 right-0 text-center"><p class="text-xs text-slate-400">Â© 2024 Itsbad Store.</p></div>
  </div>

  <!-- Admin Login Modal -->
  <div id="adminLoginModal" class="fixed inset-0 z-[200] flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-4">
      <div class="text-center mb-8"><h2 class="text-2xl font-bold text-gray-800">Admin Access</h2><p class="text-gray-600 mt-2">Masukkan PIN Admin</p></div>
      <form id="pinForm" class="space-y-6">
        <div><div class="relative"><input type="password" id="adminPin" maxlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl tracking-widest font-mono" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off" required /><button type="button" id="togglePin" class="absolute right-3 top-3 text-gray-500 hover:text-gray-700"><i class="fas fa-eye"></i></button></div></div>
        <div class="flex space-x-3"><button type="button" onclick="closeAdminLogin()" class="flex-1 py-3 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition font-medium">Batal</button><button type="submit" class="flex-1 py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Buka Panel</button></div>
      </form>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container hidden" id="app">
    <!-- Header -->
    <div class="sticky top-0 z-40 bg-white/90 backdrop-blur-md px-5 py-3 border-b border-slate-100 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-3">
             <div class="w-9 h-9 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 overflow-hidden border-2 border-white shadow">
                 <img id="headerAvatar" src="https://ui-avatars.com/api/?name=Guest&background=3b82f6&color=fff" class="w-full h-full object-cover">
             </div>
             <div><h1 class="text-sm font-bold text-slate-800 leading-none" id="shopNameDisplay">Itsbad Store</h1><p class="text-[10px] text-slate-400 mt-1" id="headerGreeting">Loading...</p></div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleSearch()" class="w-9 h-9 rounded-full bg-slate-50 flex items-center justify-center text-slate-500 hover:bg-slate-100 transition-colors">
                <i class="fas fa-search"></i>
            </button>
            
            <a href="https://cek-nomer-xl.vercel.app/" target="_blank" class="w-9 h-9 rounded-full bg-gradient-to-r from-yellow-400 to-orange-400 text-white flex items-center justify-center hover:shadow-lg transition-all" title="Cek Nomer XL/Axis">
                <i class="fas fa-sim-card"></i>
            </a>

            <button onclick="openDownloadPage()" class="px-3 py-1.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-full text-xs font-bold hover:shadow-lg transition-all flex items-center gap-2">
                <i class="fas fa-cloud-download-alt"></i> <span class="hidden sm:inline">Download</span>
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div id="searchBar" class="hidden px-5 py-2 bg-white border-b border-slate-100 slide-down">
        <div class="flex items-center gap-2">
            <i class="fas fa-search text-slate-400"></i>
            <input type="text" id="searchInput" onkeyup="filterProducts()" placeholder="Cari layanan..." class="flex-1 bg-transparent py-2 text-sm focus:outline-none placeholder:text-slate-400">
            <button onclick="toggleSearch()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="p-5 min-h-[80vh]">
        <!-- Hero Section -->
        <div class="w-full h-40 rounded-2xl bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white p-5 flex flex-col justify-center shadow-lg shadow-blue-200/50 mb-6 relative overflow-hidden">
             <div class="absolute -right-10 -top-10 w-32 h-32 bg-white/10 rounded-full blur-xl"></div>
             <div class="absolute -left-10 -bottom-10 w-32 h-32 bg-white/10 rounded-full blur-xl"></div>
             <h2 class="text-2xl font-bold relative z-10 mb-2">Premium Digital</h2>
             <p class="text-sm text-blue-100 relative z-10 max-w-[80%]">Semua kebutuhan digitalmu ada di sini. Cepat, Aman, Terpercaya.</p>
             <div class="absolute bottom-3 right-3">
                 <div class="flex items-center gap-1 bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full">
                     <i class="fas fa-bolt text-yellow-300 text-xs"></i>
                     <span class="text-[10px] font-bold">FAST DELIVERY</span>
                 </div>
             </div>
        </div>

        <!-- Auth Alert -->
        <div id="authAlert" class="hidden bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-4 mb-6 flex items-center gap-3 shadow-sm">
            <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center">
                <i class="fas fa-user-clock text-orange-500"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-sm text-orange-700">Mode Tamu</h3>
                <p class="text-xs text-orange-600">Login untuk akses fitur penuh dan riwayat pesanan.</p>
            </div>
            <button onclick="showLoginOptions()" class="bg-white text-orange-600 px-4 py-2 rounded-lg text-xs font-bold border border-orange-200 hover:bg-orange-50 transition-colors">Login</button>
        </div>

        <!-- Categories -->
        <div class="mb-6">
            <h3 class="text-sm font-bold text-slate-700 mb-3">Kategori</h3>
            <div id="categoryContainer" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>
        </div>

        <!-- Products Grid -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-slate-700">Produk Terpopuler</h3>
                <span class="text-xs text-slate-500" id="productCount">0 produk</span>
            </div>
            <div id="productGrid" class="grid grid-cols-2 gap-4">
                <!-- Products will be loaded here -->
                <div class="col-span-2">
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>Tidak ada produk</h3>
                        <p>Produk akan muncul setelah admin menambahkannya</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Promo Banner -->
        <div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-4 text-white mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-bold text-sm mb-1">ðŸŽ‰ Promo Spesial!</h4>
                    <p class="text-xs opacity-90">Gunakan kupon <span class="font-bold">DISKON10</span> untuk diskon 10%</p>
                </div>
                <div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full">
                    <span class="text-xs font-bold">HOT</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Page -->
    <div id="downloadPage" class="hidden p-5 min-h-[80vh] pb-24">
        <div class="mb-6">
            <h2 class="text-xl font-bold text-slate-800 mb-1">Aplikasi Gratis</h2>
            <p class="text-sm text-slate-500">Download aplikasi pilihan kami secara gratis.</p>
        </div>
        
        <div class="mb-6">
            <h3 class="text-sm font-bold text-slate-700 mb-3">Kategori Aplikasi</h3>
            <div id="appCategoryContainer" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>
        </div>

        <div id="appList" class="space-y-3">
            <div class="empty-state">
                <i class="fas fa-download"></i>
                <h3>Belum ada aplikasi</h3>
                <p>Aplikasi akan muncul setelah admin menambahkannya</p>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button onclick="switchTab('home')" class="nav-item active" id="nav-home">
            <i class="fas fa-home"></i> Beranda
        </button>
        <button onclick="openCart()" class="nav-item relative" id="nav-cart">
            <i class="fas fa-shopping-bag"></i>
            <span id="cartBadge" class="absolute top-0 right-6 w-4 h-4 bg-red-500 text-white text-[9px] flex items-center justify-center rounded-full border-2 border-white hidden">0</span>
            Keranjang
        </button>
        <button onclick="openProfile()" class="nav-item" id="nav-profile">
            <i class="fas fa-user"></i> Akun
        </button>
        <button id="nav-admin" onclick="openAdminLogin()" class="nav-item hidden">
            <i class="fas fa-cog"></i> Admin
        </button>
    </div>

    <!-- Product Detail Modal -->
    <div id="detailModal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeDetail()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-0 slide-up max-w-[480px] mx-auto h-[90vh] flex flex-col overflow-hidden">
            <div class="relative h-64 bg-gradient-to-b from-slate-100 to-white flex items-center justify-center">
                <button onclick="closeDetail()" class="absolute top-4 left-4 w-10 h-10 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center z-10 shadow-lg hover:bg-white">
                    <i class="fas fa-arrow-left text-slate-700"></i>
                </button>
                <img id="detailImg" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-white to-transparent"></div>
            </div>
            <div class="p-6 flex-1 flex flex-col overflow-y-auto">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <h2 id="detailName" class="text-xl font-bold text-slate-800 mb-1"></h2>
                        <div class="flex items-center gap-2">
                            <span id="detailCat" class="inline-block bg-slate-100 text-slate-600 text-xs px-3 py-1 rounded-full font-medium"></span>
                            <div class="flex items-center text-yellow-400 text-xs">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <span class="text-slate-400 ml-1 text-xs">(4.8)</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <span id="detailPrice" class="block text-xl font-bold text-blue-600"></span>
                        <span id="detailStock" class="text-xs text-slate-400">Stok: <span class="font-medium"></span></span>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 mb-4">
                    <div class="flex items-center gap-2 text-blue-700 mb-1">
                        <i class="fas fa-bolt"></i>
                        <span class="text-xs font-bold">INSTANT DELIVERY</span>
                    </div>
                    <p class="text-xs text-blue-600">Produk dikirim otomatis setelah pembayaran berhasil.</p>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-bold text-sm text-slate-800 mb-2">Deskripsi Produk</h3>
                    <p id="detailDesc" class="text-sm text-slate-600 leading-relaxed whitespace-pre-wrap"></p>
                </div>
                
                <div class="mt-auto">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm text-slate-600">Jumlah:</span>
                        <div class="flex items-center gap-2 bg-slate-100 rounded-lg px-3 py-1">
                            <button onclick="updateDetailQty(-1)" class="w-6 h-6 flex items-center justify-center text-slate-600 hover:bg-slate-200 rounded">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span id="detailQty" class="w-8 text-center font-bold">1</span>
                            <button onclick="updateDetailQty(1)" class="w-6 h-6 flex items-center justify-center text-slate-600 hover:bg-slate-200 rounded">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-white">
                <button id="btnAddToCart" onclick="addToCartFromDetail()" class="w-full bg-gradient-to-r from-slate-900 to-slate-800 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:shadow-xl active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-plus"></i> TAMBAH KE KERANJANG
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeCart()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-5 slide-up max-w-[480px] mx-auto h-[90vh] flex flex-col">
            <div class="w-12 h-1 bg-slate-300 rounded-full mx-auto mb-6"></div>
            <h2 class="font-bold text-xl mb-1 text-slate-800">Keranjang Belanja</h2>
            <p class="text-sm text-slate-500 mb-6">Total <span id="cartItemCount">0</span> item</p>
            
            <!-- Coupon Section -->
            <div id="couponSection" class="mb-4">
                <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-ticket-alt text-amber-500"></i>
                        <h3 class="font-bold text-sm text-amber-700">Pakai Kupon Diskon</h3>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="couponCode" class="flex-1 bg-white border border-amber-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-amber-400" placeholder="Masukkan kode kupon" onkeyup="if(event.key === 'Enter') applyCoupon()">
                        <button onclick="applyCoupon()" id="applyCouponBtn" class="bg-gradient-to-r from-amber-500 to-orange-500 text-white px-4 py-3 rounded-lg text-sm font-bold hover:shadow-lg transition-all">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                    <div id="couponMessage" class="text-xs mt-2"></div>
                </div>
            </div>
            
            <!-- Cart Items -->
            <div id="cartList" class="flex-1 overflow-y-auto space-y-3 mb-4"></div>
            
            <!-- Order Summary -->
            <div class="border-t border-slate-200 pt-4">
                <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-4">
                    <label class="text-xs font-bold text-blue-600 uppercase block mb-2">Catatan Pesanan</label>
                    <textarea id="orderNote" class="w-full bg-white border border-blue-200 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-400 resize-none" placeholder="Contoh: No. HP 0812xxx atau @username" rows="2"></textarea>
                    <p class="text-xs text-blue-500 mt-1">*Wajib diisi untuk pengiriman produk</p>
                </div>
                
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-600">Subtotal</span>
                        <span class="text-sm font-medium text-slate-700" id="cartSubtotalDisplay">Rp 0</span>
                    </div>
                    <div class="flex justify-between items-center hidden" id="discountRow">
                        <span class="text-sm text-green-600 flex items-center gap-1">
                            <i class="fas fa-tag"></i> Diskon Kupon
                        </span>
                        <span class="text-sm font-medium text-green-600" id="discountDisplay">-Rp 0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-600">Biaya Admin</span>
                        <span class="text-sm font-medium text-slate-700" id="feeDisplay">Rp 0</span>
                    </div>
                    <div class="border-t pt-3">
                        <div class="flex justify-between items-center">
                            <span class="text-base font-bold text-slate-800">Total</span>
                            <span class="text-xl font-bold text-blue-600" id="cartTotalDisplay">Rp 0</span>
                        </div>
                    </div>
                </div>
                
                <button onclick="initPayment()" id="btnCheckout" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <i class="fas fa-lock"></i> LANJUT KE PEMBAYARAN
                </button>
                
                <p class="text-xs text-center text-slate-500 mt-3">Dengan melanjutkan, Anda menyetujui Syarat & Ketentuan</p>
            </div>
        </div>
    </div>

    <!-- Payment Method Selection Modal -->
    <div id="paymentMethodModal" class="fixed inset-0 z-[75] hidden bg-white flex flex-col">
        <div class="p-4 border-b border-slate-200 flex items-center gap-3">
             <button onclick="closePaymentMethod()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition-colors">
                 <i class="fas fa-arrow-left text-slate-600"></i>
             </button>
             <h2 class="font-bold text-lg text-slate-800">Pilih Pembayaran</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-5">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-2xl p-4 mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-slate-600">Total Tagihan</span>
                    <span class="text-sm font-bold text-blue-600" id="paymentTotalDisplay">Rp 0</span>
                </div>
                <div class="flex items-center gap-2 text-green-600">
                    <i class="fas fa-shield-alt"></i>
                    <span class="text-xs font-bold">PEMBAYARAN AMAN 100%</span>
                </div>
            </div>
            
            <h3 class="text-sm font-bold text-slate-700 mb-3">Pilih Metode</h3>
            <div class="space-y-3 mb-8">
                <div class="payment-method cursor-pointer" onclick="selectPaymentMethod('allbank')" id="payment-allbank">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-100 to-blue-200 flex items-center justify-center">
                            <i class="fas fa-university text-blue-600 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-sm text-slate-800">All Bank (QRIS)</h4>
                            <p class="text-xs text-slate-500">Transfer via semua bank dan e-wallet</p>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center" id="check-allbank">
                            <div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-method cursor-pointer" onclick="selectPaymentMethod('dana')" id="payment-dana">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-100 to-emerald-200 flex items-center justify-center">
                            <i class="fas fa-mobile-alt text-green-600 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-sm text-slate-800">DANA</h4>
                            <p class="text-xs text-slate-500">Transfer via DANA QRIS</p>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center" id="check-dana">
                            <div class="w-3 h-3 rounded-full bg-blue-600 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                <div class="flex items-start gap-2">
                    <i class="fas fa-info-circle text-yellow-500 mt-0.5"></i>
                    <div>
                        <h4 class="text-xs font-bold text-yellow-700 mb-1">Penting!</h4>
                        <p class="text-xs text-yellow-600">Pastikan nominal yang muncul di QRIS sesuai dengan total tagihan sebelum membayar.</p>
                    </div>
                </div>
            </div>
            
            <button onclick="proceedToPayment()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                <i class="fas fa-credit-card"></i> LANJUT PEMBAYARAN
            </button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 z-[80] hidden bg-white flex flex-col">
        <div class="p-4 border-b border-slate-200 flex items-center gap-3">
             <button onclick="closePayment()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200 transition-colors">
                 <i class="fas fa-arrow-left text-slate-600"></i>
             </button>
             <h2 class="font-bold text-lg text-slate-800" id="paymentMethodTitle">Pembayaran</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-6 flex flex-col items-center">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 text-slate-700 px-6 py-3 rounded-full text-sm font-bold mb-6 shadow-sm">
                ðŸ’³ Total: <span id="payAmountDisplay" class="text-blue-600">Rp 0</span>
            </div>
            
            <!-- QR Container -->
            <div id="paymentContainer" class="w-full max-w-xs">
                <!-- QR Display -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-6">
                    <div class="text-center mb-4">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">SCAN QRIS</h3>
                        <p class="text-xs text-slate-500 mt-1" id="paymentMethodDesc"></p>
                    </div>
                    
                    <div id="qrDisplay" class="flex flex-col items-center">
                        <!-- QR Code will be inserted here -->
                        <div id="qrContainer" class="flex justify-center my-2 min-h-[200px] w-full items-center"></div>
                        
                        <div id="qrStatus" class="text-xs px-4 py-2 rounded-full font-bold mt-3"></div>
                    </div>
                    
                    <div id="manualPayment" class="mt-4 hidden">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 text-red-600 mb-2">
                                <i class="fas fa-exclamation-circle"></i>
                                <span class="text-xs font-bold">QRIS TIDAK VALID</span>
                            </div>
                            <p class="text-xs text-red-600">Silakan hubungi admin untuk melakukan pembayaran manual.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Instructions -->
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 mb-6">
                    <h4 class="text-xs font-bold text-slate-700 mb-3">Cara Bayar:</h4>
                    <ol class="text-xs text-slate-600 space-y-2">
                        <li class="flex items-start gap-2">
                            <span class="bg-blue-100 text-blue-600 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">1</span>
                            <span>Buka aplikasi e-wallet atau mobile banking</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="bg-blue-100 text-blue-600 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">2</span>
                            <span>Pilih "Scan QR" atau "QRIS"</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="bg-blue-100 text-blue-600 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">3</span>
                            <span>Scan QR Code di atas</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="bg-blue-100 text-blue-600 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">4</span>
                            <span>Pastikan nominal sesuai sebelum bayar</span>
                        </li>
                    </ol>
                </div>
                
                <!-- Timer -->
                <div class="text-center mb-6">
                    <div class="inline-flex items-center gap-2 bg-red-50 text-red-600 px-4 py-2 rounded-full">
                        <i class="fas fa-clock"></i>
                        <span class="text-sm font-bold" id="paymentTimer">15:00</span>
                        <span class="text-xs">Batas Waktu</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-5 border-t border-slate-200">
            <button onclick="generateReceipt()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                <i class="fas fa-check-circle"></i> SAYA SUDAH BAYAR
            </button>
            <p class="text-xs text-center text-slate-500 mt-3">Klik hanya jika sudah melakukan pembayaran</p>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 z-[90] hidden bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="w-full max-w-xs fade-in">
            <div id="receiptCard" class="receipt-paper p-6 rounded-t-lg">
                <!-- Store Header -->
                <div class="text-center border-b border-dashed border-slate-300 pb-4 mb-4">
                    <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center">
                        <i class="fas fa-store text-white text-xl"></i>
                    </div>
                    <h2 class="font-bold text-xl" id="recStoreName">Itsbad Store</h2>
                    <p class="text-xs text-slate-400">Bukti Pemesanan Sah</p>
                    <div class="flex items-center justify-center gap-1 mt-1">
                        <i class="fas fa-check-circle text-green-500 text-xs"></i>
                        <span class="text-[10px] text-green-600 font-bold">PAID</span>
                    </div>
                </div>
                
                <!-- Order Info -->
                <div class="space-y-2 mb-4 text-xs">
                    <div class="flex justify-between">
                        <span class="text-slate-500">Tanggal</span>
                        <span class="font-medium" id="receiptDate">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Pembeli</span>
                        <span class="font-medium" id="receiptName">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Metode</span>
                        <span class="font-medium" id="receiptMethod">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Kupon</span>
                        <span class="font-medium" id="receiptCoupon">-</span>
                    </div>
                </div>
                
                <!-- Order Items -->
                <div class="border-y border-dashed border-slate-300 py-3 mb-3 space-y-2" id="receiptItems"></div>
                
                <!-- Order Summary -->
                <div class="space-y-2 mb-3">
                    <div class="flex justify-between text-xs">
                        <span class="text-slate-500">Subtotal</span>
                        <span id="receiptSubtotal">Rp 0</span>
                    </div>
                    <div id="receiptDiscountRow" class="flex justify-between text-xs text-green-600 hidden">
                        <span>Diskon Kupon</span>
                        <span id="receiptDiscount">-Rp 0</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-slate-500">Biaya Admin</span>
                        <span id="receiptFee">Rp 0</span>
                    </div>
                    <div class="flex justify-between font-bold text-base mt-3 pt-3 border-t">
                        <span>TOTAL</span>
                        <span id="receiptTotal">Rp 0</span>
                    </div>
                </div>
                
                <!-- Order Note -->
                <div id="receiptNoteBox" class="mt-4 bg-slate-50 p-3 rounded-lg text-[11px] text-slate-600">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-sticky-note text-slate-400 mt-0.5"></i>
                        <span id="receiptNote">-</span>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="text-center mt-4 pt-4 border-t border-dashed border-slate-300">
                    <p class="text-[10px] text-slate-400">Terima kasih telah berbelanja di Itsbad Store</p>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="mt-4 gap-3 flex">
                <button onclick="closeReceipt()" class="flex-1 bg-white text-slate-700 py-3.5 rounded-xl font-bold text-sm hover:bg-slate-50 transition-colors border border-slate-200">
                    <i class="fas fa-times mr-1"></i> Tutup
                </button>
                <button id="btnSendWa" onclick="sendToWhatsapp()" disabled class="flex-[2] bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all">
                    <i class="fas fa-spinner fa-spin hidden" id="loadingIcon"></i>
                    <span id="btnWaText">KIRIM KE ADMIN</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 z-[60] hidden bg-white flex flex-col">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
            <h2 class="font-bold text-lg text-slate-800">Profil Saya</h2>
            <button onclick="closeProfile()" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center hover:bg-slate-200 transition-colors">
                <i class="fas fa-times text-slate-600"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-5">
            <!-- Profile Photo -->
            <div class="flex flex-col items-center mb-8">
                <div class="relative w-28 h-28 rounded-full bg-gradient-to-r from-blue-100 to-indigo-100 border-4 border-white shadow-lg overflow-hidden">
                    <img id="profileAvatarEdit" src="https://ui-avatars.com/api/?name=Guest&background=3b82f6&color=fff" class="w-full h-full object-cover">
                    <input type="file" id="uploadAvatar" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleAvatarUpload(this)">
                    <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs py-1 text-center">
                        <i class="fas fa-camera mr-1"></i> Ganti
                    </div>
                </div>
                <p class="text-xs text-slate-400 mt-2">Ketuk foto untuk mengganti</p>
            </div>
            
            <!-- Profile Form -->
            <div class="space-y-4 mb-8">
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">Nama Lengkap</label>
                    <input type="text" id="profName" class="input-field w-full" placeholder="Masukkan nama lengkap">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">Nomor WhatsApp</label>
                    <input type="tel" id="profPhone" class="input-field w-full" placeholder="0812xxx">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">Alamat (Opsional)</label>
                    <textarea id="profAddress" class="input-field w-full" placeholder="Masukkan alamat lengkap" rows="3"></textarea>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <button onclick="saveProfileData()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all mb-3">
                <i class="fas fa-save mr-2"></i> SIMPAN PROFIL
            </button>
            <button onclick="doLogout()" class="w-full border-2 border-red-200 text-red-500 bg-red-50 py-3.5 rounded-xl font-bold hover:bg-red-100 transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i> KELUAR
            </button>
            
            <!-- Order History -->
            <div class="mt-10 pt-6 border-t border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-bold text-sm text-slate-700">Riwayat Pesanan</h4>
                    <span class="text-xs text-slate-500" id="historyCount">0 pesanan</span>
                </div>
                <div id="historyList" class="space-y-3">
                    <div class="text-center py-8">
                        <i class="fas fa-history text-slate-300 text-2xl mb-2"></i>
                        <p class="text-sm text-slate-400">Belum ada riwayat pesanan</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminModal" class="fixed inset-0 z-[90] hidden bg-slate-100 overflow-y-auto">
        <!-- Admin Header -->
        <div class="sticky top-0 bg-white p-4 shadow-sm flex justify-between items-center z-50 border-b border-slate-200">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center">
                    <i class="fas fa-cog text-white text-sm"></i>
                </div>
                <h2 class="font-bold text-lg text-slate-800">Admin Panel</h2>
            </div>
            <div class="flex gap-2">
                <button onclick="switchAdminTab('products')" id="tabAdmProd" class="admin-tab active">
                    <i class="fas fa-box mr-1"></i> Produk
                </button>
                <button onclick="switchAdminTab('apps')" id="tabAdmApp" class="admin-tab">
                    <i class="fas fa-rocket mr-1"></i> Apps
                </button>
                <button onclick="switchAdminTab('payments')" id="tabAdmPay" class="admin-tab">
                    <i class="fas fa-credit-card mr-1"></i> Bayar
                </button>
                <button onclick="switchAdminTab('coupons')" id="tabAdmCoupon" class="admin-tab">
                    <i class="fas fa-ticket-alt mr-1"></i> Kupon
                </button>
                <button onclick="closeAdminPanel()" class="w-8 h-8 flex items-center justify-center text-red-500 hover:text-red-600 ml-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Admin Content -->
        <div class="p-5 space-y-6" id="adminContent">
            <!-- Store Settings -->
            <div class="admin-card">
                <h3 class="admin-section-title flex items-center">
                    <i class="fas fa-store mr-2"></i> Pengaturan Toko
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 mb-1 block">Nama Toko</label>
                        <input id="admStoreName" class="input-field w-full" placeholder="Nama Toko" value="Itsbad Store">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">Fee Admin</label>
                            <input id="admFee" type="number" class="input-field w-full" placeholder="0">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">PIN Admin</label>
                            <input id="admPin" type="text" class="input-field w-full bg-slate-50" value="110603" readonly>
                        </div>
                    </div>
                    <button onclick="saveAdmSettings()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-bold hover:shadow-lg transition-all">
                        <i class="fas fa-save mr-2"></i> Simpan Pengaturan
                    </button>
                </div>
            </div>

            <!-- Products Management -->
            <div id="adminPanelProducts" class="space-y-6">
                <!-- Add Product Form -->
                <div class="admin-card">
                    <h3 class="admin-section-title flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Tambah Produk Baru
                    </h3>
                    <div class="space-y-4">
                        <!-- Image Upload -->
                        <div class="flex gap-4">
                            <div onclick="document.getElementById('admImgInp').click()" class="w-24 h-24 bg-slate-100 rounded-xl flex items-center justify-center cursor-pointer border-2 border-dashed border-slate-300 hover:border-blue-400 transition-colors flex-shrink-0">
                                <img id="admImgPrev" class="w-full h-full object-cover rounded-xl hidden">
                                <div id="admImgIcon" class="text-center">
                                    <i class="fas fa-camera text-slate-400 text-xl mb-1"></i>
                                    <p class="text-[10px] text-slate-500">Upload Gambar</p>
                                </div>
                            </div>
                            <input type="file" id="admImgInp" class="hidden" onchange="handleAdmImg(this)">
                            
                            <div class="flex-1 space-y-3">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">Nama Produk</label>
                                    <input id="admPName" class="input-field w-full" placeholder="Nama Produk">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">Kategori</label>
                                    <input list="catList" id="admPCat" class="input-field w-full" placeholder="Pilih atau ketik kategori">
                                    <datalist id="catList"></datalist>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">Link Gambar (Opsional)</label>
                                    <input type="text" id="admImgLink" class="input-field w-full text-sm" placeholder="https://example.com/image.jpg" onchange="handleAdmImgLink(this)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Price & Stock -->
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Harga</label>
                                <input id="admPPrice" type="number" class="input-field w-full" placeholder="Harga">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Stok</label>
                                <input id="admPStock" type="number" class="input-field w-full" placeholder="Stok">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Terjual</label>
                                <input id="admPSold" type="number" class="input-field w-full" placeholder="Terjual">
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">Deskripsi</label>
                            <textarea id="admPDesc" class="input-field w-full" placeholder="Deskripsi produk" rows="3"></textarea>
                        </div>
                        
                        <!-- Action Buttons -->
                        <input type="hidden" id="admEditIdx" value="-1">
                        <div class="flex gap-2">
                            <button onclick="saveAdmProd()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg font-bold hover:shadow-lg transition-all">
                                <i class="fas fa-save mr-1"></i> Simpan Produk
                            </button>
                            <button onclick="resetAdmForm()" class="px-4 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300 transition-colors">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Product List -->
                <div class="admin-card">
                    <h3 class="admin-section-title flex items-center">
                        <i class="fas fa-list mr-2"></i> Daftar Produk (<span id="productListCount">0</span>)
                    </h3>
                    <div id="admList" class="space-y-3">
                        <div class="text-center py-6">
                            <i class="fas fa-box-open text-slate-300 text-xl mb-2"></i>
                            <p class="text-sm text-slate-400">Belum ada produk</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Apps Management -->
            <div id="adminPanelApps" class="space-y-6 hidden">
                <!-- Add App Form -->
                <div class="admin-card">
                    <h3 class="admin-section-title flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Tambah Aplikasi Baru
                    </h3>
                    <div class="space-y-4">
                        <!-- Image Upload -->
                        <div class="flex gap-4">
                            <div onclick="document.getElementById('admAppImgInp').click()" class="w-24 h-24 bg-slate-100 rounded-xl flex items-center justify-center cursor-pointer border-2 border-dashed border-slate-300 hover:border-blue-400 transition-colors flex-shrink-0">
                                <img id="admAppImgPrev" class="w-full h-full object-cover rounded-xl hidden">
                                <div id="admAppImgIcon" class="text-center">
                                    <i class="fas fa-cube text-slate-400 text-xl mb-1"></i>
                                    <p class="text-[10px] text-slate-500">Upload Icon</p>
                                </div>
                            </div>
                            <input type="file" id="admAppImgInp" class="hidden" onchange="handleAdmAppImg(this)">
                            
                            <div class="flex-1 space-y-3">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">Nama Aplikasi</label>
                                    <input id="admAppName" class="input-field w-full" placeholder="Nama Aplikasi">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">Kategori</label>
                                    <input id="admAppCat" class="input-field w-full" placeholder="Game, Tools, dll">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 mb-1 block">Link Icon (Opsional)</label>
                                    <input type="text" id="admAppImgLink" class="input-field w-full text-sm" placeholder="https://example.com/icon.png" onchange="handleAdmAppImgLink(this)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Download Link -->
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">Link Download</label>
                            <input id="admAppLink" class="input-field w-full" placeholder="https://drive.google.com/...">
                            <p class="text-xs text-slate-500 mt-1">Support: Google Drive, Mediafire, Direct Link</p>
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">Deskripsi</label>
                            <textarea id="admAppDesc" class="input-field w-full" placeholder="Deskripsi singkat aplikasi" rows="2"></textarea>
                        </div>
                        
                        <!-- Action Buttons -->
                        <input type="hidden" id="admAppEditIdx" value="-1">
                        <div class="flex gap-2">
                            <button onclick="saveAdmApp()" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-lg font-bold hover:shadow-lg transition-all">
                                <i class="fas fa-save mr-1"></i> Simpan Aplikasi
                            </button>
                            <button onclick="resetAdmAppForm()" class="px-4 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300 transition-colors">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- App List -->
                <div class="admin-card">
                    <h3 class="admin-section-title flex items-center">
                        <i class="fas fa-list mr-2"></i> Daftar Aplikasi (<span id="appListCount">0</span>)
                    </h3>
                    <div id="admAppList" class="space-y-3">
                        <div class="text-center py-6">
                            <i class="fas fa-download text-slate-300 text-xl mb-2"></i>
                            <p class="text-sm text-slate-400">Belum ada aplikasi</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods Management -->
            <div id="adminPanelPayments" class="space-y-6 hidden">
                <!-- Payment Settings -->
                <div class="admin-card">
                    <h3 class="admin-section-title flex items-center">
                        <i class="fas fa-credit-card mr-2"></i> Pengaturan Pembayaran
                    </h3>
                    <div class="space-y-6">
                        <!-- All Bank QRIS -->
                        <div class="border border-slate-200 rounded-xl p-4 bg-gradient-to-r from-blue-50 to-indigo-50">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-100 to-blue-200 flex items-center justify-center">
                                        <i class="fas fa-university text-blue-600 text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-sm text-slate-800">All Bank (QRIS)</h4>
                                        <p class="text-xs text-slate-500">Transfer via semua bank</p>
                                    </div>
                                </div>
                                <span id="allbankStatus" class="badge badge-success">Aktif</span>
                            </div>
                            <div class="space-y-3">
                                <label class="text-xs font-bold text-slate-500">Upload QRIS All Bank</label>
                                <input type="file" id="qrisAllBankFile" class="input-field w-full" onchange="handleQrisUpload('allbank', this)" accept="image/*">
                                <input type="text" id="admQrisAllBank" class="input-field w-full bg-slate-50" placeholder="String QRIS akan muncul di sini" readonly>
                                <p class="text-xs text-slate-500">Upload gambar QRIS untuk All Bank. Format harus PNG/JPG dengan QR code yang jelas.</p>
                            </div>
                        </div>
                        
                        <!-- DANA QRIS -->
                        <div class="border border-slate-200 rounded-xl p-4 bg-gradient-to-r from-green-50 to-emerald-50">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-100 to-emerald-200 flex items-center justify-center">
                                        <i class="fas fa-mobile-alt text-green-600 text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-sm text-slate-800">DANA QRIS</h4>
                                        <p class="text-xs text-slate-500">Transfer via DANA</p>
                                    </div>
                                </div>
                                <span id="danaStatus" class="badge badge-warning">Belum diatur</span>
                            </div>
                            <div class="space-y-3">
                                <label class="text-xs font-bold text-slate-500">Upload QRIS DANA</label>
                                <input type="file" id="qrisDanaFile" class="input-field w-full" onchange="handleQrisUpload('dana', this)" accept="image/*">
                                <input type="text" id="admQrisDana" class="input-field w-full bg-slate-50" placeholder="String QRIS akan muncul di sini" readonly>
                                <p class="text-xs text-slate-500">Upload gambar QRIS khusus untuk DANA. Pastikan QRIS dari DANA merchant.</p>
                            </div>
                        </div>
                        
                        <button onclick="savePaymentSettings()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-bold hover:shadow-lg transition-all">
                            <i class="fas fa-save mr-2"></i> Simpan Pengaturan Pembayaran
                        </button>
                        
                        <!-- Warning -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-exclamation-triangle text-red-500 mt-0.5"></i>
                                <div>
                                    <h4 class="text-xs font-bold text-red-700 mb-1">Penting!</h4>
                                    <p class="text-xs text-red-600">Pastikan QRIS yang diupload valid dan masih aktif. QRIS yang tidak valid akan menyebabkan pembayaran gagal.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coupons Management -->
            <div id="adminPanelCoupons" class="space-y-6 hidden">
                <!-- Add Coupon Form -->
                <div class="admin-card">
                    <h3 class="admin-section-title flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Buat Kupon Baru
                    </h3>
                    <div class="space-y-4">
                        <!-- Basic Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Kode Kupon</label>
                                <input id="admCouponCode" class="input-field w-full font-bold uppercase" placeholder="DISKON50" maxlength="20">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Jenis Diskon</label>
                                <select id="admCouponType" class="input-field w-full" onchange="toggleCouponValueType()">
                                    <option value="percentage">Persentase (%)</option>
                                    <option value="fixed">Nominal Tetap (Rp)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Discount Value -->
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block" id="couponValueLabel">Nilai Diskon (%)</label>
                            <input id="admCouponValue" type="number" class="input-field w-full" placeholder="10" min="1">
                        </div>
                        
                        <!-- Limits -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Min. Belanja (Rp)</label>
                                <input id="admCouponMin" type="number" class="input-field w-full" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Maks. Diskon (Rp)</label>
                                <input id="admCouponMax" type="number" class="input-field w-full" placeholder="0 = tak terbatas" min="0">
                            </div>
                        </div>
                        
                        <!-- Validity -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Mulai Berlaku</label>
                                <input id="admCouponStart" type="date" class="input-field w-full">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">Berlaku Sampai</label>
                                <input id="admCouponEnd" type="date" class="input-field w-full">
                            </div>
                        </div>
                        
                        <!-- Usage Limit -->
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">Maks. Penggunaan</label>
                            <input id="admCouponUsage" type="number" class="input-field w-full" placeholder="0 = tak terbatas" min="0">
                            <p class="text-xs text-slate-500 mt-1">Isi 0 untuk penggunaan tak terbatas</p>
                        </div>
                        
                        <!-- Action Buttons -->
                        <input type="hidden" id="admCouponEditIdx" value="-1">
                        <div class="flex gap-2">
                            <button onclick="saveAdmCoupon()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-bold hover:shadow-lg transition-all">
                                <i class="fas fa-save mr-1"></i> Simpan Kupon
                            </button>
                            <button onclick="resetAdmCouponForm()" class="px-4 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300 transition-colors">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Coupon List -->
                <div class="admin-card">
                    <h3 class="admin-section-title flex items-center">
                        <i class="fas fa-list mr-2"></i> Daftar Kupon (<span id="couponListCount">0</span>)
                    </h3>
                    <div id="admCouponList" class="space-y-3">
                        <div class="text-center py-6">
                            <i class="fas fa-ticket-alt text-slate-300 text-xl mb-2"></i>
                            <p class="text-sm text-slate-400">Belum ada kupon</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  
  <!-- Firebase and Main Application -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAUL2WkPlJLb8wHcSKQ_QA7GSZ5DGw94Ng",
      authDomain: "kasir-online-c22bd.firebaseapp.com",
      databaseURL: "https://kasir-online-c22bd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kasir-online-c22bd",
      storageBucket: "kasir-online-c22bd.firebasestorage.app",
      messagingSenderId: "1052259146588",
      appId: "1:1052259146588:web:a3f4e9c31982cbfa2dff99"
    };
    
    const STORE_ID = "itsbad-store";
    const OWNER_WA = "6285236363128";
    const ADMIN_PIN = "110603";
    const ADMIN_EMAIL = "isbadd84@gmail.com";
    
    let db, auth, user;
    let storeData = {
      name: "Itsbad Store",
      fee: 0,
      products: [],
      downloads: [],
      payments: {
        allbank: "",
        dana: ""
      },
      coupons: []
    };
    
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let userProfile = {};
    let tempAdmImg = "";
    let tempAdmAppImg = "";
    let currentDetailIdx = -1;
    let currentDetailQty = 1;
    let activeCategory = 'all';
    let activeAppCategory = 'all';
    let isGuestMode = false;
    let selectedPaymentMethod = 'allbank';
    let appliedCoupon = null;
    let discountAmount = 0;
    let paymentTimer = null;
    let paymentTimeLeft = 900; // 15 minutes in seconds
    
    // Toast Configuration
    toastr.options = {
      "positionClass": "toast-top-center",
      "timeOut": "3000",
      "showMethod": "slideDown",
      "hideMethod": "slideUp",
      "closeButton": true,
      "progressBar": true,
      "newestOnTop": true
    };

    // --- QRIS UTILITY FUNCTIONS ---
    function generateCRC16(data) {
        let crc = 0xFFFF;
        for (let i = 0; i < data.length; i++) {
            crc ^= data.charCodeAt(i) << 8;
            for (let j = 0; j < 8; j++) {
                if ((crc & 0x8000) !== 0) {
                    crc = (crc << 1) ^ 0x1021;
                } else {
                    crc = crc << 1;
                }
                crc = crc & 0xFFFF;
            }
        }
        return crc.toString(16).toUpperCase().padStart(4, "0");
    }
    
    function parseTLV(payload) {
        const items = [];
        let pos = 0;
        while (pos < payload.length) {
            const id = payload.substr(pos, 2);
            const lenStr = payload.substr(pos + 2, 2);
            const len = parseInt(lenStr, 10);
            if (isNaN(len)) break;
            const val = payload.substr(pos + 4, len);
            items.push({ id, val });
            pos += 4 + len;
        }
        return items;
    }
    
    function buildTLV(items) {
        return items.map(item => {
            const len = item.val.length.toString().padStart(2, '0');
            return item.id + len + item.val;
        }).join('');
    }
    
    function formatQrisAmount(qrisRaw, amount) {
        try {
            let tlv = parseTLV(qrisRaw.trim());
            
            // Remove existing CRC
            tlv = tlv.filter(x => x.id !== '63');
            
            // Set payload format indicator to dynamic
            const idx01 = tlv.findIndex(x => x.id === '01');
            if (idx01 >= 0) tlv[idx01].val = '12';
            
            // Remove existing amount tag if exists
            tlv = tlv.filter(x => x.id !== '54');
            
            // Add new amount tag
            const amountStr = amount.toString();
            const tag54 = { id: '54', val: amountStr };
            
            // Try to insert after tag 53 (currency)
            const idx53 = tlv.findIndex(x => x.id === '53');
            if (idx53 >= 0) {
                tlv.splice(idx53 + 1, 0, tag54);
            } else {
                // Insert before CRC if no tag 53
                tlv.push(tag54);
            }
            
            let body = buildTLV(tlv);
            const crcInput = body + "6304";
            const crc = generateCRC16(crcInput);
            return body + "6304" + crc;
        } catch (error) {
            console.error("Error formatting QRIS:", error);
            return qrisRaw; // Return original if error
        }
    }
    
    function validateQRIS(qrisString) {
        if (!qrisString || qrisString.length < 20) return false;
        
        try {
            // Basic QRIS validation
            const tlv = parseTLV(qrisString);
            
            // Check for required tags
            const hasTag00 = tlv.some(x => x.id === '00');
            const hasTag01 = tlv.some(x => x.id === '01');
            const hasTag52 = tlv.some(x => x.id === '52');
            
            return hasTag00 && hasTag01 && hasTag52;
        } catch (error) {
            return false;
        }
    }

    // --- INITIALIZATION FUNCTIONS ---
    function showLoading(show) {
        const loadingScreen = document.getElementById('loadingScreen');
        if (show) {
            loadingScreen.classList.remove('hidden');
        } else {
            loadingScreen.classList.add('hidden');
        }
    }
    
    function updateProductCount() {
        const count = storeData.products.length;
        document.getElementById('productCount').textContent = `${count} produk`;
        document.getElementById('productListCount').textContent = count;
    }
    
    function updateAppCount() {
        const count = storeData.downloads?.length || 0;
        document.getElementById('appListCount').textContent = count;
    }
    
    function updateCouponCount() {
        const count = storeData.coupons?.length || 0;
        document.getElementById('couponListCount').textContent = count;
    }
    
    function updateCartItemCount() {
        const total = cart.reduce((sum, item) => sum + (item.qty || 0), 0);
        document.getElementById('cartItemCount').textContent = total;
    }

    // --- MAIN FUNCTIONS ---
    window.loginWithGoogle = async () => {
        try {
            showLoading(true);
            const provider = new GoogleAuthProvider();
            const result = await signInWithPopup(auth, provider);
            user = result.user;
            isGuestMode = false;
            
            // Check if admin
            if (user.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('nav-admin').classList.remove('hidden');
                toastr.success("Login sebagai Admin berhasil!");
            } else {
                toastr.success("Login berhasil!");
            }
            
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            await loadProfile(user.uid);
            await initStore();
            
            // Check for admin page parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('page') === 'admin') {
                setTimeout(() => {
                    openAdminLogin();
                    // Remove parameter from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }, 1000);
            }
        } catch (error) {
            console.error("Login error:", error);
            toastr.error("Gagal login. Silakan coba lagi.");
        } finally {
            showLoading(false);
        }
    };
    
    window.continueAsGuest = () => {
        isGuestMode = true;
        user = { uid: 'guest_' + Date.now() };
        userProfile = { name: 'Tamu' };
        
        toastr.info("Mode Tamu aktif");
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('headerGreeting').innerText = "Mode Tamu";
        initStore();
    };
    
    window.initStore = async () => {
        try {
            showLoading(true);
            
            // Load store data
            const snapshot = await get(child(ref(db), `stores/${STORE_ID}`));
            if (snapshot.exists()) {
                const data = snapshot.val();
                
                // Ensure all required fields exist
                storeData = {
                    name: data.name || "Itsbad Store",
                    fee: data.fee || 0,
                    products: data.products || [],
                    downloads: data.downloads || [],
                    payments: data.payments || { allbank: "", dana: "" },
                    coupons: data.coupons || []
                };
            } else {
                // Create initial store data
                await set(ref(db, `stores/${STORE_ID}`), storeData);
            }
            
            // Update UI
            document.getElementById('shopNameDisplay').innerText = storeData.name;
            renderCategories();
            renderProducts();
            renderAppCategories();
            renderDownloadPage();
            updateCartBadge();
            updateProductCount();
            updateAppCount();
            updateCouponCount();
            
            // Show coupon section if there are active coupons
            const hasActiveCoupons = storeData.coupons?.some(coupon => {
                const now = Date.now();
                const start = coupon.startDate || 0;
                const end = coupon.endDate || Infinity;
                const isActive = now >= start && now <= end;
                const hasUsage = coupon.maxUsage === 0 || (coupon.usedCount || 0) < coupon.maxUsage;
                return isActive && hasUsage;
            });
            
            document.getElementById('couponSection').classList.toggle('hidden', !hasActiveCoupons);
            
        } catch (error) {
            console.error("Error loading store:", error);
            toastr.error("Gagal memuat data toko");
        } finally {
            showLoading(false);
        }
    };
    
    // --- COUPON FUNCTIONS ---
    window.applyCoupon = async () => {
        const code = document.getElementById('couponCode').value.trim().toUpperCase();
        const messageDiv = document.getElementById('couponMessage');
        const button = document.getElementById('applyCouponBtn');
        
        if (!code) {
            messageDiv.innerHTML = '<span class="text-red-500 text-xs">Masukkan kode kupon</span>';
            return;
        }
        
        // Show loading
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        try {
            // Find coupon
            const coupon = storeData.coupons?.find(c => c.code === code);
            const now = Date.now();
            
            if (!coupon) {
                messageDiv.innerHTML = '<span class="text-red-500 text-xs">Kode kupon tidak ditemukan</span>';
                return;
            }
            
            // Check validity
            const start = coupon.startDate || 0;
            const end = coupon.endDate || Infinity;
            
            if (now < start) {
                const startDate = new Date(start).toLocaleDateString('id-ID');
                messageDiv.innerHTML = `<span class="text-yellow-600 text-xs">Kupon berlaku mulai ${startDate}</span>`;
                return;
            }
            
            if (now > end) {
                messageDiv.innerHTML = '<span class="text-red-500 text-xs">Kupon telah kadaluarsa</span>';
                return;
            }
            
            // Check usage limit
            if (coupon.maxUsage > 0 && (coupon.usedCount || 0) >= coupon.maxUsage) {
                messageDiv.innerHTML = '<span class="text-red-500 text-xs">Kupon sudah habis digunakan</span>';
                return;
            }
            
            // Calculate subtotal
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            // Check minimum purchase
            if (subtotal < coupon.minPurchase) {
                messageDiv.innerHTML = `<span class="text-red-500 text-xs">Minimal belanja Rp ${coupon.minPurchase.toLocaleString('id-ID')}</span>`;
                return;
            }
            
            // Calculate discount
            let discount = 0;
            if (coupon.type === 'percentage') {
                discount = (subtotal * coupon.value) / 100;
                if (coupon.maxDiscount > 0 && discount > coupon.maxDiscount) {
                    discount = coupon.maxDiscount;
                }
            } else {
                discount = Math.min(coupon.value, subtotal); // Can't discount more than subtotal
            }
            
            // Apply discount
            appliedCoupon = coupon;
            discountAmount = Math.round(discount);
            
            // Show success message
            const discountText = coupon.type === 'percentage' 
                ? `${coupon.value}%` 
                : `Rp ${coupon.value.toLocaleString('id-ID')}`;
            
            messageDiv.innerHTML = `
                <div class="text-green-600 text-xs">
                    <div class="flex items-center gap-1">
                        <i class="fas fa-check-circle"></i>
                        <span class="font-bold">Kupon berhasil digunakan!</span>
                    </div>
                    <div>Diskon: ${discountText} (Rp ${discountAmount.toLocaleString('id-ID')})</div>
                </div>
            `;
            
            // Update cart display
            renderCartList();
            
        } catch (error) {
            console.error("Error applying coupon:", error);
            messageDiv.innerHTML = '<span class="text-red-500 text-xs">Gagal menggunakan kupon</span>';
        } finally {
            // Restore button
            button.innerHTML = originalText;
            button.disabled = false;
        }
    };
    
    window.removeCoupon = () => {
        appliedCoupon = null;
        discountAmount = 0;
        document.getElementById('couponCode').value = '';
        document.getElementById('couponMessage').innerHTML = '';
        renderCartList();
    };
    
    // --- PAYMENT FUNCTIONS ---
    window.initPayment = () => {
        if (!cart.length) {
            toastr.error("Keranjang kosong");
            return;
        }
        
        const note = document.getElementById('orderNote').value.trim();
        if (!note) {
            toastr.error("Harap isi catatan pesanan (No. HP atau username)");
            document.getElementById('orderNote').focus();
            return;
        }
        
        // Calculate total
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const fee = parseInt(storeData.fee) || 0;
        const total = subtotal + fee - discountAmount;
        
        // Update payment method modal
        document.getElementById('paymentTotalDisplay').innerText = `Rp ${total.toLocaleString('id-ID')}`;
        
        // Reset payment method selection
        selectPaymentMethod('allbank');
        
        // Show payment method modal
        document.getElementById('cartModal').classList.add('hidden');
        setTimeout(() => {
            document.getElementById('paymentMethodModal').classList.remove('hidden');
        }, 300);
    };
    
    window.selectPaymentMethod = (method) => {
        selectedPaymentMethod = method;
        
        // Reset all checks
        document.querySelectorAll('.payment-method').forEach(el => {
            el.classList.remove('active');
            const checkId = `check-${el.id.split('-')[1]}`;
            const checkDiv = document.getElementById(checkId);
            checkDiv.querySelector('div')?.classList.add('hidden');
            checkDiv.style.borderColor = '#cbd5e1';
        });
        
        // Activate selected
        const selectedEl = document.getElementById(`payment-${method}`);
        selectedEl.classList.add('active');
        const checkDiv = document.getElementById(`check-${method}`);
        checkDiv.querySelector('div')?.classList.remove('hidden');
        checkDiv.style.borderColor = '#3b82f6';
    };
    
    window.startPaymentTimer = () => {
        clearInterval(paymentTimer);
        paymentTimeLeft = 900; // 15 minutes
        
        paymentTimer = setInterval(() => {
            paymentTimeLeft--;
            
            if (paymentTimeLeft <= 0) {
                clearInterval(paymentTimer);
                toastr.warning("Waktu pembayaran telah habis");
                closePayment();
                return;
            }
            
            const minutes = Math.floor(paymentTimeLeft / 60);
            const seconds = paymentTimeLeft % 60;
            document.getElementById('paymentTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    };
    
    window.proceedToPayment = () => {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const fee = parseInt(storeData.fee) || 0;
        const total = subtotal + fee - discountAmount;
        
        // Update payment modal
        document.getElementById('payAmountDisplay').innerText = `Rp ${total.toLocaleString('id-ID')}`;
        
        if (selectedPaymentMethod === 'allbank') {
            document.getElementById('paymentMethodTitle').innerText = 'Pembayaran All Bank';
            document.getElementById('paymentMethodDesc').innerText = 'Scan dengan aplikasi bank atau e-wallet';
        } else {
            document.getElementById('paymentMethodTitle').innerText = 'Pembayaran DANA';
            document.getElementById('paymentMethodDesc').innerText = 'Scan dengan aplikasi DANA';
        }
        
        // Hide payment method modal and show payment modal
        document.getElementById('paymentMethodModal').classList.add('hidden');
        setTimeout(() => {
            document.getElementById('paymentModal').classList.remove('hidden');
            generatePaymentQR(total);
            startPaymentTimer();
        }, 300);
    };
    
    window.generatePaymentQR = (amount) => {
        const container = document.getElementById('qrContainer');
        container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto mb-3"></div><p class="text-sm text-slate-500">Menyiapkan QRIS...</p></div>';
        
        const statusDiv = document.getElementById('qrStatus');
        const manualPaymentDiv = document.getElementById('manualPayment');
        
        setTimeout(() => {
            try {
                // Get QRIS string based on selected payment method
                const qrisString = storeData.payments?.[selectedPaymentMethod] || '';
                
                // Validate QRIS
                if (!qrisString || !validateQRIS(qrisString)) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-3"></i>
                            <p class="text-sm text-red-500 font-bold mb-1">QRIS tidak tersedia</p>
                            <p class="text-xs text-slate-500">Silakan hubungi admin untuk pembayaran manual</p>
                        </div>
                    `;
                    
                    statusDiv.innerHTML = '<span class="text-red-500">QRIS Tidak Valid</span>';
                    statusDiv.className = 'text-xs px-4 py-2 rounded-full font-bold mt-3 bg-red-100 text-red-700';
                    
                    manualPaymentDiv.classList.remove('hidden');
                    return;
                }
                
                // Format QRIS with amount
                let finalQr = qrisString;
                let statusText = "Nominal Otomatis";
                let statusClass = "bg-green-100 text-green-700";
                
                try {
                    finalQr = formatQrisAmount(qrisString, amount);
                } catch (error) {
                    console.error("Error formatting QRIS:", error);
                    statusText = "Scan Manual";
                    statusClass = "bg-yellow-100 text-yellow-700";
                }
                
                // Clear container and generate QR code
                container.innerHTML = "";
                new QRCode(container, {
                    text: finalQr,
                    width: 200,
                    height: 200,
                    colorDark: "#1e293b",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Update status
                statusDiv.innerHTML = `<span>${statusText}</span>`;
                statusDiv.className = `text-xs px-4 py-2 rounded-full font-bold mt-3 ${statusClass}`;
                
                // Hide manual payment warning
                manualPaymentDiv.classList.add('hidden');
                
            } catch (error) {
                console.error("Error generating QR:", error);
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-times-circle text-red-400 text-3xl mb-3"></i>
                        <p class="text-sm text-red-500 font-bold mb-1">Error generating QR</p>
                        <p class="text-xs text-slate-500">Silakan coba lagi atau hubungi admin</p>
                    </div>
                `;
                
                statusDiv.innerHTML = '<span class="text-red-500">Error</span>';
                statusDiv.className = 'text-xs px-4 py-2 rounded-full font-bold mt-3 bg-red-100 text-red-700';
            }
        }, 500);
    };
    
    // --- RECEIPT AND ORDER FUNCTIONS ---
    window.generateReceipt = async () => {
        const note = document.getElementById('orderNote').value.trim();
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const fee = parseInt(storeData.fee) || 0;
        const total = subtotal + fee - discountAmount;
        
        // Stop payment timer
        clearInterval(paymentTimer);
        
        // Update coupon usage if applied
        if (appliedCoupon) {
            const couponIndex = storeData.coupons.findIndex(c => c.code === appliedCoupon.code);
            if (couponIndex !== -1) {
                storeData.coupons[couponIndex].usedCount = (storeData.coupons[couponIndex].usedCount || 0) + 1;
                await update(ref(db, `stores/${STORE_ID}/coupons/${couponIndex}`), storeData.coupons[couponIndex]);
            }
        }
        
        // Update receipt display
        const now = new Date();
        document.getElementById('recStoreName').innerText = storeData.name;
        document.getElementById('receiptDate').innerText = now.toLocaleDateString('id-ID', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('receiptName').innerText = userProfile.name || "Tamu";
        document.getElementById('receiptMethod').innerText = selectedPaymentMethod === 'allbank' ? 'All Bank QRIS' : 'DANA QRIS';
        document.getElementById('receiptCoupon').innerText = appliedCoupon?.code || '-';
        document.getElementById('receiptSubtotal').innerText = `Rp ${subtotal.toLocaleString('id-ID')}`;
        document.getElementById('receiptFee').innerText = `Rp ${fee.toLocaleString('id-ID')}`;
        document.getElementById('receiptTotal').innerText = `Rp ${total.toLocaleString('id-ID')}`;
        document.getElementById('receiptNote').innerText = note || '-';
        
        // Update receipt items
        const ri = document.getElementById('receiptItems');
        ri.innerHTML = "";
        cart.forEach(item => {
            const itemTotal = item.price * item.qty;
            ri.innerHTML += `
                <div class="flex justify-between items-start text-sm">
                    <div class="flex-1">
                        <div class="font-medium">${item.name}</div>
                        <div class="text-xs text-slate-500">${item.qty} Ã— Rp ${item.price.toLocaleString('id-ID')}</div>
                    </div>
                    <div class="font-bold">Rp ${itemTotal.toLocaleString('id-ID')}</div>
                </div>
            `;
        });
        
        // Update discount row
        const discountRow = document.getElementById('receiptDiscountRow');
        if (appliedCoupon && discountAmount > 0) {
            discountRow.classList.remove('hidden');
            document.getElementById('receiptDiscount').innerText = `-Rp ${discountAmount.toLocaleString('id-ID')}`;
        } else {
            discountRow.classList.add('hidden');
        }
        
        // Update button state
        const btnWa = document.getElementById('btnSendWa');
        const btnText = document.getElementById('btnWaText');
        const loadIcon = document.getElementById('loadingIcon');
        
        btnWa.disabled = true;
        btnText.innerText = "MENYIMPAN...";
        loadIcon.classList.remove('hidden');
        
        // Show receipt modal
        document.getElementById('paymentModal').classList.add('hidden');
        setTimeout(() => {
            document.getElementById('receiptModal').classList.remove('hidden');
        }, 300);
        
        // Save order to database
        if (user && !isGuestMode) {
            try {
                const orderRef = await push(ref(db, `orders/${user.uid}`), {
                    items: [...cart],
                    subtotal,
                    fee,
                    discount: discountAmount,
                    total,
                    note,
                    paymentMethod: selectedPaymentMethod,
                    coupon: appliedCoupon?.code || null,
                    date: Date.now(),
                    status: "pending",
                    customerName: userProfile.name,
                    customerPhone: userProfile.phone,
                    customerEmail: user.email
                });
                
                // Update order ID
                await update(ref(db, `orders/${user.uid}/${orderRef.key}`), { orderId: orderRef.key });
                
                toastr.success("Pesanan berhasil disimpan");
                btnWa.disabled = false;
                btnText.innerText = "KIRIM KE ADMIN";
                loadIcon.classList.add('hidden');
                
            } catch (error) {
                console.error("Error saving order:", error);
                toastr.error("Gagal menyimpan pesanan");
                btnText.innerText = "GAGAL SIMPAN";
                loadIcon.classList.add('hidden');
            }
        } else {
            // Guest mode
            setTimeout(() => {
                btnWa.disabled = false;
                btnText.innerText = "KIRIM KE ADMIN";
                loadIcon.classList.add('hidden');
                toastr.info("Mode Tamu: Pesanan tidak disimpan");
            }, 1500);
        }
    };
    
    window.sendToWhatsapp = () => {
        const note = document.getElementById('orderNote').value.trim() || "-";
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const fee = parseInt(storeData.fee) || 0;
        const total = subtotal + fee - discountAmount;
        
        const now = new Date();
        const dateStr = now.toLocaleDateString('id-ID', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        const timeStr = now.toLocaleTimeString('id-ID', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let message = `*ð™Žð™ð™ð™ð™† ð™‹ð™€ð™ˆð™€ð™Žð˜¼ð™‰ð˜¼ð™‰ - ${storeData.name}*\n`;
        message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
        message += `ðŸ‘¤ *Pembeli:* ${userProfile.name || 'Tamu'}\n`;
        message += `ðŸ“… *Tanggal:* ${dateStr}\n`;
        message += `â° *Waktu:* ${timeStr} WIB\n`;
        message += `ðŸ’³ *Metode:* ${selectedPaymentMethod === 'allbank' ? 'All Bank (QRIS)' : 'DANA'}\n`;
        message += `ðŸŽ« *Kupon:* ${appliedCoupon ? appliedCoupon.code : '-'}\n`;
        message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
        message += `*DETAIL PESANAN:*\n`;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.qty;
            message += `âž¤ ${item.name}\n`;
            message += `   ${item.qty} Ã— Rp ${item.price.toLocaleString('id-ID')} = Rp ${itemTotal.toLocaleString('id-ID')}\n`;
        });
        
        message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
        message += `ðŸ’° *Subtotal:* Rp ${subtotal.toLocaleString('id-ID')}\n`;
        
        if (appliedCoupon && discountAmount > 0) {
            message += `ðŸŽ« *Diskon:* -Rp ${discountAmount.toLocaleString('id-ID')}\n`;
        }
        
        message += `ðŸ’¼ *Biaya Admin:* Rp ${fee.toLocaleString('id-ID')}\n`;
        message += `ðŸ’µ *TOTAL:* Rp ${total.toLocaleString('id-ID')}\n`;
        message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
        message += `ðŸ“ *Catatan:* ${note}\n`;
        message += `â™¾ï¸ *Status:* Pending\n`;
        message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
        message += `ðŸ™ *Terima kasih telah berbelanja!*\n`;
        message += `â³ *Tunggu admin segera memproses pesanan Anda.*\n\n`;
        message += `âš ï¸ *KIRIM BUKTI PEMBAYARAN* âš ï¸`;
        
        // Encode message for URL
        const encodedMessage = encodeURIComponent(message);
        
        // Open WhatsApp
        window.open(`https://wa.me/${OWNER_WA}?text=${encodedMessage}`, '_blank');
        
        // Clear cart and reset after delay
        setTimeout(() => {
            cart = [];
            appliedCoupon = null;
            discountAmount = 0;
            currentDetailQty = 1;
            saveCart();
            updateCartBadge();
            updateCartItemCount();
            closeReceipt();
            toastr.success("Pesanan berhasil dikirim ke admin");
        }, 2000);
    };
    
    // --- PRODUCT AND UI FUNCTIONS ---
    window.renderProducts = (q = "") => {
        const g = document.getElementById('productGrid');
        
        // Filter products
        let filtered = storeData.products;
        if (activeCategory !== 'all') {
            filtered = filtered.filter(p => (p.category || 'Umum') === activeCategory);
        }
        if (q) {
            filtered = filtered.filter(p => 
                p.name.toLowerCase().includes(q) || 
                (p.desc || '').toLowerCase().includes(q)
            );
        }
        
        if (!filtered.length) {
            g.innerHTML = `
                <div class="col-span-2">
                    <div class="empty-state">
                        <i class="fas fa-search text-slate-300 text-3xl"></i>
                        <h3 class="text-slate-600">Tidak ada produk</h3>
                        <p class="text-slate-400">${q ? 'Coba kata kunci lain' : 'Admin belum menambah produk'}</p>
                    </div>
                </div>
            `;
            return;
        }
        
        g.innerHTML = "";
        filtered.forEach((p, index) => {
            const originalIndex = storeData.products.indexOf(p);
            const img = p.image || `https://placehold.co/200x200/e2e8f0/94a3b8?text=${p.name.charAt(0)}`;
            const isOutOfStock = parseInt(p.stock) <= 0;
            const soldCount = p.sold || 0;
            const price = parseInt(p.price).toLocaleString('id-ID');
            
            g.innerHTML += `
                <div class="product-card bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-md transition-all duration-300" onclick="openDetail(${originalIndex})">
                    ${isOutOfStock ? `
                        <div class="absolute top-2 right-2 z-10">
                            <span class="badge badge-danger text-xs">HABIS</span>
                        </div>
                    ` : ''}
                    
                    <div class="aspect-square bg-slate-50 overflow-hidden relative">
                        <img src="${img}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105" loading="lazy">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent p-2">
                            <span class="text-xs font-bold text-white">Rp ${price}</span>
                        </div>
                    </div>
                    
                    <div class="p-3">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded-full font-medium truncate">${p.category || 'Umum'}</span>
                            <div class="flex items-center text-slate-400">
                                <i class="fas fa-shopping-cart text-[8px] mr-1"></i>
                                <span class="text-[9px]">${soldCount}</span>
                            </div>
                        </div>
                        
                        <h3 class="font-bold text-sm text-slate-800 mb-1 line-clamp-2 leading-tight">${p.name}</h3>
                        
                        <div class="flex justify-between items-center mt-2">
                            <div class="flex items-center">
                                ${isOutOfStock ? `
                                    <span class="text-xs text-red-500 font-bold">Stok Habis</span>
                                ` : `
                                    <span class="text-xs text-green-600 font-bold">Stok: ${p.stock}</span>
                                `}
                            </div>
                            <button class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 text-white flex items-center justify-center text-xs hover:shadow-md transition-all">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
    };
    
    window.openDetail = (i) => {
        currentDetailIdx = i;
        currentDetailQty = 1;
        const p = storeData.products[i];
        
        // Update detail modal
        document.getElementById('detailImg').src = p.image || `https://placehold.co/300x300/e2e8f0/94a3b8?text=${p.name.charAt(0)}`;
        document.getElementById('detailName').innerText = p.name;
        document.getElementById('detailPrice').innerText = `Rp ${parseInt(p.price).toLocaleString('id-ID')}`;
        document.getElementById('detailStock').innerHTML = `Stok: <span class="font-medium">${p.stock}</span>`;
        document.getElementById('detailCat').innerText = p.category || 'Umum';
        document.getElementById('detailDesc').innerText = p.desc || 'Tidak ada deskripsi';
        document.getElementById('detailQty').innerText = currentDetailQty;
        
        // Update add to cart button
        const btn = document.getElementById('btnAddToCart');
        const isOutOfStock = parseInt(p.stock) <= 0;
        
        if (isOutOfStock) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-times"></i> STOK HABIS';
            btn.classList.remove('from-slate-900', 'to-slate-800');
            btn.classList.add('from-slate-300', 'to-slate-400');
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus"></i> TAMBAH KE KERANJANG';
            btn.classList.remove('from-slate-300', 'to-slate-400');
            btn.classList.add('from-slate-900', 'to-slate-800');
        }
        
        // Show modal
        document.getElementById('detailModal').classList.remove('hidden');
    };
    
    window.updateDetailQty = (change) => {
        const p = storeData.products[currentDetailIdx];
        const stock = parseInt(p.stock);
        
        currentDetailQty += change;
        if (currentDetailQty < 1) currentDetailQty = 1;
        if (currentDetailQty > stock) currentDetailQty = stock;
        
        document.getElementById('detailQty').innerText = currentDetailQty;
    };
    
    window.addToCartFromDetail = () => {
        if (currentDetailIdx > -1) {
            const p = storeData.products[currentDetailIdx];
            const stock = parseInt(p.stock);
            
            if (stock <= 0) {
                toastr.error("Stok produk habis");
                return;
            }
            
            // Check if already in cart
            const existingItem = cart.find(item => item.idx === currentDetailIdx);
            const newQty = (existingItem?.qty || 0) + currentDetailQty;
            
            if (newQty > stock) {
                toastr.error(`Stok tidak mencukupi. Stok tersedia: ${stock}`);
                return;
            }
            
            if (existingItem) {
                existingItem.qty = newQty;
            } else {
                cart.push({
                    idx: currentDetailIdx,
                    name: p.name,
                    price: parseInt(p.price),
                    qty: currentDetailQty
                });
            }
            
            saveCart();
            toastr.success(`${p.name} ditambahkan ke keranjang`);
            closeDetail();
        }
    };
    
    window.renderCartList = () => {
        const l = document.getElementById('cartList');
        l.innerHTML = "";
        
        if (!cart.length) {
            l.innerHTML = `
                <div class="empty-state py-8">
                    <i class="fas fa-shopping-bag text-slate-300 text-3xl"></i>
                    <h3 class="text-slate-600">Keranjang Kosong</h3>
                    <p class="text-slate-400">Tambahkan produk ke keranjang</p>
                </div>
            `;
            document.getElementById('btnCheckout').disabled = true;
            updateCartItemCount();
            return;
        }
        
        let subtotal = 0;
        cart.forEach((item, index) => {
            const p = storeData.products[item.idx];
            const itemTotal = item.price * item.qty;
            subtotal += itemTotal;
            
            l.innerHTML += `
                <div class="flex items-center bg-white border border-slate-100 rounded-xl p-3 hover:shadow-sm transition-all">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-sm text-slate-800 truncate">${item.name}</h4>
                        <p class="text-xs text-blue-600 font-bold mt-1">Rp ${item.price.toLocaleString('id-ID')}</p>
                    </div>
                    <div class="flex items-center gap-2 bg-slate-50 rounded-lg px-2 py-1">
                        <button onclick="modQty(${index}, -1)" class="w-7 h-7 font-bold text-slate-600 hover:bg-slate-200 rounded-full transition-colors">âˆ’</button>
                        <span class="text-sm font-bold w-6 text-center">${item.qty}</span>
                        <button onclick="modQty(${index}, 1)" class="w-7 h-7 font-bold text-slate-600 hover:bg-slate-200 rounded-full transition-colors">+</button>
                    </div>
                </div>
            `;
        });
        
        const fee = parseInt(storeData.fee) || 0;
        const discountRow = document.getElementById('discountRow');
        const total = subtotal + fee - discountAmount;
        
        // Update display
        document.getElementById('cartSubtotalDisplay').innerText = `Rp ${subtotal.toLocaleString('id-ID')}`;
        document.getElementById('feeDisplay').innerText = `Rp ${fee.toLocaleString('id-ID')}`;
        document.getElementById('cartTotalDisplay').innerText = `Rp ${total.toLocaleString('id-ID')}`;
        document.getElementById('btnCheckout').disabled = false;
        
        // Update discount display
        if (appliedCoupon && discountAmount > 0) {
            discountRow.classList.remove('hidden');
            document.getElementById('discountDisplay').innerText = `-Rp ${discountAmount.toLocaleString('id-ID')}`;
        } else {
            discountRow.classList.add('hidden');
        }
        
        updateCartItemCount();
    };
    
    window.modQty = (index, delta) => {
        if (!cart[index]) return;
        
        const p = storeData.products[cart[index].idx];
        const stock = parseInt(p.stock);
        const newQty = cart[index].qty + delta;
        
        if (newQty < 1) {
            cart.splice(index, 1);
        } else if (newQty > stock) {
            toastr.error(`Stok tidak mencukupi. Stok tersedia: ${stock}`);
            return;
        } else {
            cart[index].qty = newQty;
        }
        
        saveCart();
        renderCartList();
        
        if (newQty < 1) {
            toastr.info("Produk dihapus dari keranjang");
        }
    };
    
    // --- OTHER FUNCTIONS ---
    window.saveCart = () => {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartBadge();
    };
    
    window.updateCartBadge = () => {
        const total = cart.reduce((sum, item) => sum + (item.qty || 0), 0);
        const badge = document.getElementById('cartBadge');
        if (total > 0) {
            badge.textContent = total > 99 ? '99+' : total;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    };
    
    // Attach all functions to window
    Object.assign(window, {
        // Navigation
        switchTab: (t) => {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${t}`).classList.add('active');
            
            const home = document.getElementById('homePage');
            const down = document.getElementById('downloadPage');
            
            if (t === 'home') {
                home.classList.remove('hidden');
                down.classList.add('hidden');
            } else if (t === 'cart' || t === 'profile') {
                home.classList.remove('hidden');
                down.classList.add('hidden');
            }
        },
        
        // Modal Controls
        toggleSearch: () => {
            const searchBar = document.getElementById('searchBar');
            searchBar.classList.toggle('hidden');
            if (!searchBar.classList.contains('hidden')) {
                document.getElementById('searchInput').focus();
            }
        },
        
        openCart: () => {
            renderCartList();
            document.getElementById('cartModal').classList.remove('hidden');
        },
        
        closeCart: () => {
            document.getElementById('cartModal').classList.add('hidden');
        },
        
        closeDetail: () => {
            document.getElementById('detailModal').classList.add('hidden');
        },
        
        closePaymentMethod: () => {
            document.getElementById('paymentMethodModal').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('cartModal').classList.remove('hidden');
            }, 300);
        },
        
        closePayment: () => {
            clearInterval(paymentTimer);
            document.getElementById('paymentModal').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('paymentMethodModal').classList.remove('hidden');
            }, 300);
        },
        
        closeReceipt: () => {
            document.getElementById('receiptModal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            cart = [];
            appliedCoupon = null;
            discountAmount = 0;
            currentDetailQty = 1;
            saveCart();
            updateCartBadge();
            updateCartItemCount();
            location.reload();
        },
        
        openDownloadPage: () => {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('searchBar').classList.add('hidden');
            document.getElementById('downloadPage').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            renderDownloadPage();
            renderAppCategories();
        },
        
        openProfile: () => {
            if (!user || isGuestMode) {
                window.showLoginOptions();
            } else {
                document.getElementById('profileModal').classList.remove('hidden');
            }
        },
        
        closeProfile: () => {
            document.getElementById('profileModal').classList.add('hidden');
        },
        
        showLoginOptions: () => {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
        },
        
        // Admin Functions
        checkAdmin: () => {
            const pin = document.getElementById('adminPin').value;
            if (pin === ADMIN_PIN) {
                document.getElementById('adminLoginModal').classList.add('hidden');
                document.getElementById('adminModal').classList.remove('hidden');
                loadAdminData();
                toastr.success("Admin panel dibuka");
            } else {
                toastr.error("PIN Salah");
            }
        },
        
        openAdminLogin: () => {
            if (!user || user.email?.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                toastr.error("Akses Ditolak");
                return;
            }
            document.getElementById('adminLoginModal').classList.remove('hidden');
        },
        
        closeAdminLogin: () => {
            document.getElementById('adminLoginModal').classList.add('hidden');
        },
        
        closeAdminPanel: () => {
            document.getElementById('adminModal').classList.add('hidden');
        },
        
        loadAdminData: () => {
            document.getElementById('admStoreName').value = storeData.name || "";
            document.getElementById('admFee').value = storeData.fee || 0;
            document.getElementById('admPin').value = ADMIN_PIN;
            document.getElementById('admQrisAllBank').value = storeData.payments?.allbank || "";
            document.getElementById('admQrisDana').value = storeData.payments?.dana || "";
            
            // Update status badges
            document.getElementById('allbankStatus').textContent = storeData.payments?.allbank ? 'Aktif' : 'Belum diatur';
            document.getElementById('allbankStatus').className = storeData.payments?.allbank ? 'badge badge-success' : 'badge badge-warning';
            
            document.getElementById('danaStatus').textContent = storeData.payments?.dana ? 'Aktif' : 'Belum diatur';
            document.getElementById('danaStatus').className = storeData.payments?.dana ? 'badge badge-success' : 'badge badge-warning';
            
            renderAdmList();
            renderAdmAppList();
            renderAdmCouponList();
            updateProductCount();
            updateAppCount();
            updateCouponCount();
        },
        
        switchAdminTab: (tab) => {
            // Hide all panels
            document.getElementById('adminPanelProducts').classList.add('hidden');
            document.getElementById('adminPanelApps').classList.add('hidden');
            document.getElementById('adminPanelPayments').classList.add('hidden');
            document.getElementById('adminPanelCoupons').classList.add('hidden');
            
            // Remove active from all tabs
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected panel and activate tab
            const panelId = `adminPanel${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
            const tabId = `tabAdm${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
            
            document.getElementById(panelId).classList.remove('hidden');
            document.getElementById(tabId).classList.add('active');
        },
        
        // Category Functions
        renderCategories: () => {
            const cats = ['all'];
            const dl = document.getElementById('catList');
            dl.innerHTML = "";
            
            storeData.products.forEach(p => {
                const c = p.category || 'Umum';
                if (!cats.includes(c)) {
                    cats.push(c);
                    if (!Array.from(dl.options).some(o => o.value === c)) {
                        const option = document.createElement('option');
                        option.value = c;
                        dl.appendChild(option);
                    }
                }
            });
            
            const container = document.getElementById('categoryContainer');
            container.innerHTML = "";
            cats.forEach(k => {
                container.innerHTML += `
                    <button onclick="filterCat('${k}')" class="cat-btn px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap transition-all ${k === activeCategory ? 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-sm' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50'}">
                        ${k === 'all' ? 'Semua' : k}
                    </button>
                `;
            });
        },
        
        filterCat: (c) => {
            activeCategory = c;
            renderCategories();
            renderProducts();
        },
        
        filterProducts: () => {
            const query = document.getElementById('searchInput').value.toLowerCase();
            renderProducts(query);
        },
        
        // Download Page Functions
        renderAppCategories: () => {
            const cats = ['all'];
            if (storeData.downloads) {
                storeData.downloads.forEach(a => {
                    const c = a.category || 'Umum';
                    if (!cats.includes(c)) cats.push(c);
                });
            }
            
            const container = document.getElementById('appCategoryContainer');
            container.innerHTML = "";
            cats.forEach(k => {
                container.innerHTML += `
                    <button onclick="filterAppCat('${k}')" class="cat-btn px-4 py-2 rounded-full text-xs font-medium whitespace-nowrap transition-all ${k === activeAppCategory ? 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-sm' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50'}">
                        ${k === 'all' ? 'Semua' : k}
                    </button>
                `;
            });
        },
        
        filterAppCat: (c) => {
            activeAppCategory = c;
            renderAppCategories();
            renderDownloadPage();
        },
        
        renderDownloadPage: () => {
            const list = document.getElementById('appList');
            
            let apps = storeData.downloads || [];
            if (activeAppCategory !== 'all') {
                apps = apps.filter(a => (a.category || 'Umum') === activeAppCategory);
            }
            
            if (apps.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-download text-slate-300 text-3xl"></i>
                        <h3 class="text-slate-600">Belum ada aplikasi</h3>
                        <p class="text-slate-400">${activeAppCategory !== 'all' ? 'Coba kategori lain' : 'Admin belum menambah aplikasi'}</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = "";
            apps.forEach((app, index) => {
                const img = app.icon || `https://placehold.co/100x100/e2e8f0/94a3b8?text=${app.name.charAt(0)}`;
                
                list.innerHTML += `
                    <div class="app-item flex items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all">
                        <div class="w-14 h-14 rounded-xl bg-slate-50 mr-4 overflow-hidden border border-slate-100 flex-shrink-0">
                            <img src="${img}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 mr-3 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-sm text-slate-800 truncate">${app.name}</h3>
                                <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded-full">${app.category || 'Umum'}</span>
                            </div>
                            <p class="text-xs text-slate-500 line-clamp-2 leading-relaxed">${app.desc || "Tidak ada deskripsi"}</p>
                        </div>
                        <a href="${app.link}" target="_blank" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg text-xs font-bold hover:shadow-lg transition-all flex flex-col items-center whitespace-nowrap">
                            <i class="fas fa-cloud-download-alt text-sm mb-1"></i>
                            <span>GET</span>
                        </a>
                    </div>
                `;
            });
        },
        
        // Admin Product CRUD
        handleAdmImg: (input) => {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                toastr.error("File harus berupa gambar");
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                toastr.error("Ukuran gambar maksimal 5MB");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    
                    // Resize if too large
                    if (w > 800) {
                        h = (h * 800) / w;
                        w = 800;
                    }
                    
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    tempAdmImg = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('admImgPrev').src = tempAdmImg;
                    document.getElementById('admImgPrev').classList.remove('hidden');
                    document.getElementById('admImgIcon').classList.add('hidden');
                    
                    toastr.success("Gambar berhasil diupload");
                };
                img.src = e.target.result;
            };
            reader.onerror = () => {
                toastr.error("Gagal membaca file");
            };
            reader.readAsDataURL(file);
        },
        
        handleAdmImgLink: (input) => {
            const url = input.value.trim();
            if (!url) return;
            
            // Simple URL validation
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                toastr.error("URL harus dimulai dengan http:// atau https://");
                return;
            }
            
            tempAdmImg = url;
            document.getElementById('admImgPrev').src = url;
            document.getElementById('admImgPrev').classList.remove('hidden');
            document.getElementById('admImgIcon').classList.add('hidden');
            
            toastr.success("Link gambar disimpan");
        },
        
        editAdm: (i) => {
            const p = storeData.products[i];
            
            // Fill form
            document.getElementById('admPName').value = p.name;
            document.getElementById('admPPrice').value = p.price;
            document.getElementById('admPStock').value = p.stock;
            document.getElementById('admPSold').value = p.sold || 0;
            document.getElementById('admPDesc').value = p.desc || '';
            document.getElementById('admPCat').value = p.category || '';
            document.getElementById('admEditIdx').value = i;
            document.getElementById('admImgLink').value = '';
            
            // Handle image
            if (p.image) {
                tempAdmImg = p.image;
                document.getElementById('admImgPrev').src = p.image;
                document.getElementById('admImgPrev').classList.remove('hidden');
                document.getElementById('admImgIcon').classList.add('hidden');
                
                if (p.image.startsWith('http')) {
                    document.getElementById('admImgLink').value = p.image;
                }
            } else {
                document.getElementById('admImgPrev').classList.add('hidden');
                document.getElementById('admImgIcon').classList.remove('hidden');
            }
            
            // Scroll to form
            document.getElementById('adminPanelProducts').scrollIntoView({ behavior: 'smooth' });
            
            toastr.info("Edit produk: " + p.name);
        },
        
        delAdm: async (i) => {
            if (!confirm('Hapus produk ini?')) return;
            
            try {
                const productName = storeData.products[i].name;
                storeData.products.splice(i, 1);
                
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                
                renderAdmList();
                renderProducts();
                renderCategories();
                updateProductCount();
                
                toastr.success(`Produk "${productName}" dihapus`);
            } catch (error) {
                console.error("Error deleting product:", error);
                toastr.error("Gagal menghapus produk");
            }
        },
        
        saveAdmProd: async () => {
            // Validate form
            const name = document.getElementById('admPName').value.trim();
            const price = document.getElementById('admPPrice').value;
            const stock = document.getElementById('admPStock').value;
            const category = document.getElementById('admPCat').value.trim() || 'Umum';
            const editIdx = parseInt(document.getElementById('admEditIdx').value);
            
            if (!name) {
                toastr.error("Nama produk harus diisi");
                return;
            }
            
            if (!price || parseFloat(price) <= 0) {
                toastr.error("Harga harus diisi dan lebih dari 0");
                return;
            }
            
            if (!stock || parseInt(stock) < 0) {
                toastr.error("Stok harus diisi dan tidak negatif");
                return;
            }
            
            const product = {
                name,
                category,
                price: parseFloat(price),
                stock: parseInt(stock),
                sold: parseInt(document.getElementById('admPSold').value) || 0,
                desc: document.getElementById('admPDesc').value.trim() || '',
                image: tempAdmImg || ''
            };
            
            try {
                if (editIdx > -1) {
                    // Update existing product
                    storeData.products[editIdx] = product;
                    toastr.success(`Produk "${name}" diperbarui`);
                } else {
                    // Add new product
                    storeData.products.push(product);
                    toastr.success(`Produk "${name}" ditambahkan`);
                }
                
                // Save to database
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                
                // Reset form and update UI
                resetAdmForm();
                renderAdmList();
                renderProducts();
                renderCategories();
                updateProductCount();
                
            } catch (error) {
                console.error("Error saving product:", error);
                toastr.error("Gagal menyimpan produk");
            }
        },
        
        resetAdmForm: () => {
            document.getElementById('admPName').value = '';
            document.getElementById('admPPrice').value = '';
            document.getElementById('admPStock').value = '';
            document.getElementById('admPSold').value = '';
            document.getElementById('admPDesc').value = '';
            document.getElementById('admPCat').value = '';
            document.getElementById('admImgLink').value = '';
            document.getElementById('admEditIdx').value = '-1';
            
            tempAdmImg = '';
            document.getElementById('admImgPrev').classList.add('hidden');
            document.getElementById('admImgIcon').classList.remove('hidden');
        },
        
        renderAdmList: () => {
            const list = document.getElementById('admList');
            
            if (!storeData.products.length) {
                list.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-box-open text-slate-300 text-xl mb-2"></i>
                        <p class="text-sm text-slate-400">Belum ada produk</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            storeData.products.forEach((p, i) => {
                const isFirst = i === 0;
                const isLast = i === storeData.products.length - 1;
                
                list.innerHTML += `
                    <div class="flex items-center justify-between bg-white p-4 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-12 h-12 rounded-lg bg-slate-100 overflow-hidden flex-shrink-0">
                                ${p.image ? 
                                    `<img src="${p.image}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full flex items-center justify-center text-slate-400"><i class="fas fa-box"></i></div>`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-sm text-slate-800 truncate">${p.name}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">${p.category || 'Umum'}</span>
                                    <span class="text-xs text-slate-500">Stok: ${p.stock}</span>
                                </div>
                                <p class="text-xs text-blue-600 font-bold mt-1">Rp ${parseInt(p.price).toLocaleString('id-ID')}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <button onclick="moveProd(${i}, -1)" class="w-8 h-8 bg-slate-100 rounded text-slate-600 hover:bg-slate-200 flex items-center justify-center ${isFirst ? 'opacity-30 cursor-not-allowed' : ''}" ${isFirst ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up text-xs"></i>
                            </button>
                            <button onclick="moveProd(${i}, 1)" class="w-8 h-8 bg-slate-100 rounded text-slate-600 hover:bg-slate-200 flex items-center justify-center ${isLast ? 'opacity-30 cursor-not-allowed' : ''}" ${isLast ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down text-xs"></i>
                            </button>
                            <div class="w-px h-4 bg-slate-200 mx-1"></div>
                            <button onclick="editAdm(${i})" class="w-8 h-8 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded flex items-center justify-center">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button onclick="delAdm(${i})" class="w-8 h-8 bg-red-50 text-red-600 hover:bg-red-100 rounded flex items-center justify-center">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        },
        
        moveProd: async (i, dir) => {
            const arr = storeData.products;
            const target = i + dir;
            
            if (target < 0 || target >= arr.length) return;
            
            // Swap positions
            [arr[i], arr[target]] = [arr[target], arr[i]];
            
            renderAdmList();
            renderProducts();
            
            try {
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                toastr.success("Urutan produk diperbarui");
            } catch (error) {
                console.error("Error updating order:", error);
                toastr.error("Gagal memperbarui urutan");
            }
        },
        
        // Admin App CRUD
        handleAdmAppImg: (input) => {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                toastr.error("File harus berupa gambar");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    
                    // Resize if too large
                    if (w > 400) {
                        h = (h * 400) / w;
                        w = 400;
                    }
                    
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    tempAdmAppImg = canvas.toDataURL('image/png', 0.9);
                    document.getElementById('admAppImgPrev').src = tempAdmAppImg;
                    document.getElementById('admAppImgPrev').classList.remove('hidden');
                    document.getElementById('admAppImgIcon').classList.add('hidden');
                    
                    toastr.success("Icon berhasil diupload");
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        },
        
        handleAdmAppImgLink: (input) => {
            const url = input.value.trim();
            if (!url) return;
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                toastr.error("URL harus dimulai dengan http:// atau https://");
                return;
            }
            
            tempAdmAppImg = url;
            document.getElementById('admAppImgPrev').src = url;
            document.getElementById('admAppImgPrev').classList.remove('hidden');
            document.getElementById('admAppImgIcon').classList.add('hidden');
            
            toastr.success("Link icon disimpan");
        },
        
        saveAdmApp: async () => {
            const name = document.getElementById('admAppName').value.trim();
            const link = document.getElementById('admAppLink').value.trim();
            const category = document.getElementById('admAppCat').value.trim() || 'Umum';
            const editIdx = parseInt(document.getElementById('admAppEditIdx').value);
            
            if (!name) {
                toastr.error("Nama aplikasi harus diisi");
                return;
            }
            
            if (!link) {
                toastr.error("Link download harus diisi");
                return;
            }
            
            if (!link.startsWith('http://') && !link.startsWith('https://')) {
                toastr.error("Link harus dimulai dengan http:// atau https://");
                return;
            }
            
            const app = {
                name,
                link,
                category,
                desc: document.getElementById('admAppDesc').value.trim() || '',
                icon: tempAdmAppImg || ''
            };
            
            try {
                if (!storeData.downloads) storeData.downloads = [];
                
                if (editIdx > -1) {
                    storeData.downloads[editIdx] = app;
                    toastr.success(`Aplikasi "${name}" diperbarui`);
                } else {
                    storeData.downloads.push(app);
                    toastr.success(`Aplikasi "${name}" ditambahkan`);
                }
                
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                
                resetAdmAppForm();
                renderAdmAppList();
                renderDownloadPage();
                renderAppCategories();
                updateAppCount();
                
            } catch (error) {
                console.error("Error saving app:", error);
                toastr.error("Gagal menyimpan aplikasi");
            }
        },
        
        editAdmApp: (i) => {
            const app = storeData.downloads[i];
            
            document.getElementById('admAppName').value = app.name;
            document.getElementById('admAppLink').value = app.link;
            document.getElementById('admAppCat').value = app.category || '';
            document.getElementById('admAppDesc').value = app.desc || '';
            document.getElementById('admAppEditIdx').value = i;
            document.getElementById('admAppImgLink').value = '';
            
            if (app.icon) {
                tempAdmAppImg = app.icon;
                document.getElementById('admAppImgPrev').src = app.icon;
                document.getElementById('admAppImgPrev').classList.remove('hidden');
                document.getElementById('admAppImgIcon').classList.add('hidden');
                
                if (app.icon.startsWith('http')) {
                    document.getElementById('admAppImgLink').value = app.icon;
                }
            } else {
                document.getElementById('admAppImgPrev').classList.add('hidden');
                document.getElementById('admAppImgIcon').classList.remove('hidden');
            }
            
            document.getElementById('adminPanelApps').scrollIntoView({ behavior: 'smooth' });
            toastr.info("Edit aplikasi: " + app.name);
        },
        
        delAdmApp: async (i) => {
            if (!confirm('Hapus aplikasi ini?')) return;
            
            try {
                const appName = storeData.downloads[i].name;
                storeData.downloads.splice(i, 1);
                
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                
                renderAdmAppList();
                renderDownloadPage();
                renderAppCategories();
                updateAppCount();
                
                toastr.success(`Aplikasi "${appName}" dihapus`);
            } catch (error) {
                console.error("Error deleting app:", error);
                toastr.error("Gagal menghapus aplikasi");
            }
        },
        
        resetAdmAppForm: () => {
            document.getElementById('admAppName').value = '';
            document.getElementById('admAppLink').value = '';
            document.getElementById('admAppCat').value = '';
            document.getElementById('admAppDesc').value = '';
            document.getElementById('admAppImgLink').value = '';
            document.getElementById('admAppEditIdx').value = '-1';
            
            tempAdmAppImg = '';
            document.getElementById('admAppImgPrev').classList.add('hidden');
            document.getElementById('admAppImgIcon').classList.remove('hidden');
        },
        
        renderAdmAppList: () => {
            const list = document.getElementById('admAppList');
            
            if (!storeData.downloads || !storeData.downloads.length) {
                list.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-download text-slate-300 text-xl mb-2"></i>
                        <p class="text-sm text-slate-400">Belum ada aplikasi</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            storeData.downloads.forEach((app, i) => {
                list.innerHTML += `
                    <div class="flex items-center justify-between bg-white p-4 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-12 h-12 rounded-lg bg-slate-100 overflow-hidden flex-shrink-0">
                                ${app.icon ? 
                                    `<img src="${app.icon}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full flex items-center justify-center text-slate-400"><i class="fas fa-cube"></i></div>`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-sm text-slate-800 truncate">${app.name}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded">${app.category || 'Umum'}</span>
                                </div>
                                <p class="text-xs text-slate-500 truncate mt-1">${app.link}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <button onclick="editAdmApp(${i})" class="w-8 h-8 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded flex items-center justify-center">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button onclick="delAdmApp(${i})" class="w-8 h-8 bg-red-50 text-red-600 hover:bg-red-100 rounded flex items-center justify-center">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        },
        
        // Admin Payment Settings
        handleQrisUpload: async (type, input) => {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                toastr.error("File harus berupa gambar");
                return;
            }
            
            showLoading(true);
            
            try {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        try {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, canvas.width, canvas.height);
                            
                            if (code) {
                                const qrisInput = document.getElementById(`admQris${type === 'allbank' ? 'AllBank' : 'Dana'}`);
                                qrisInput.value = code.data;
                                
                                // Validate QRIS
                                if (validateQRIS(code.data)) {
                                    toastr.success(`QRIS ${type === 'allbank' ? 'All Bank' : 'DANA'} berhasil diambil`);
                                    
                                    // Update status badge
                                    const statusEl = document.getElementById(`${type}Status`);
                                    statusEl.textContent = 'Aktif';
                                    statusEl.className = 'badge badge-success';
                                } else {
                                    toastr.warning("QRIS ditemukan tetapi mungkin tidak valid. Pastikan ini QRIS yang benar.");
                                }
                            } else {
                                toastr.error("QR Code tidak ditemukan dalam gambar");
                            }
                        } catch (error) {
                            console.error("Error reading QR:", error);
                            toastr.error("Gagal membaca QR Code");
                        }
                    };
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                    toastr.error("Gagal membaca file");
                };
                reader.readAsDataURL(file);
            } finally {
                showLoading(false);
            }
        },
        
        savePaymentSettings: async () => {
            try {
                storeData.payments = {
                    allbank: document.getElementById('admQrisAllBank').value.trim(),
                    dana: document.getElementById('admQrisDana').value.trim()
                };
                
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                
                toastr.success("Pengaturan pembayaran disimpan");
            } catch (error) {
                console.error("Error saving payment settings:", error);
                toastr.error("Gagal menyimpan pengaturan pembayaran");
            }
        },
        
        // Admin Coupon Functions
        toggleCouponValueType: () => {
            const type = document.getElementById('admCouponType').value;
            const label = document.getElementById('couponValueLabel');
            
            if (type === 'percentage') {
                label.innerText = 'Nilai Diskon (%)';
                document.getElementById('admCouponValue').placeholder = '10';
            } else {
                label.innerText = 'Nilai Diskon (Rp)';
                document.getElementById('admCouponValue').placeholder = '5000';
            }
        },
        
        saveAdmCoupon: async () => {
            const code = document.getElementById('admCouponCode').value.trim().toUpperCase();
            const type = document.getElementById('admCouponType').value;
            const value = parseFloat(document.getElementById('admCouponValue').value);
            const minPurchase = parseFloat(document.getElementById('admCouponMin').value) || 0;
            const maxDiscount = parseFloat(document.getElementById('admCouponMax').value) || 0;
            const startDate = document.getElementById('admCouponStart').value;
            const endDate = document.getElementById('admCouponEnd').value;
            const maxUsage = parseInt(document.getElementById('admCouponUsage').value) || 0;
            const editIdx = parseInt(document.getElementById('admCouponEditIdx').value);
            
            // Validation
            if (!code) {
                toastr.error("Kode kupon harus diisi");
                return;
            }
            
            if (!value || value <= 0) {
                toastr.error("Nilai diskon harus diisi dan lebih dari 0");
                return;
            }
            
            if (type === 'percentage' && value > 100) {
                toastr.error("Diskon persentase tidak boleh lebih dari 100%");
                return;
            }
            
            if (!startDate || !endDate) {
                toastr.error("Tanggal mulai dan berakhir harus diisi");
                return;
            }
            
            const start = new Date(startDate).getTime();
            const end = new Date(endDate).getTime();
            
            if (end <= start) {
                toastr.error("Tanggal berakhir harus setelah tanggal mulai");
                return;
            }
            
            const coupon = {
                code,
                type,
                value,
                minPurchase,
                maxDiscount,
                startDate: start,
                endDate: end,
                maxUsage,
                usedCount: 0,
                createdAt: Date.now()
            };
            
            try {
                if (!storeData.coupons) storeData.coupons = [];
                
                if (editIdx > -1) {
                    // Preserve used count when editing
                    coupon.usedCount = storeData.coupons[editIdx].usedCount || 0;
                    storeData.coupons[editIdx] = coupon;
                    toastr.success(`Kupon "${code}" diperbarui`);
                } else {
                    // Check for duplicate code
                    if (storeData.coupons.some(c => c.code === code)) {
                        toastr.error("Kode kupon sudah digunakan");
                        return;
                    }
                    storeData.coupons.push(coupon);
                    toastr.success(`Kupon "${code}" ditambahkan`);
                }
                
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                
                resetAdmCouponForm();
                renderAdmCouponList();
                updateCouponCount();
                
                // Show coupon section in cart if not already shown
                document.getElementById('couponSection').classList.remove('hidden');
                
            } catch (error) {
                console.error("Error saving coupon:", error);
                toastr.error("Gagal menyimpan kupon");
            }
        },
        
        renderAdmCouponList: () => {
            const list = document.getElementById('admCouponList');
            
            if (!storeData.coupons || !storeData.coupons.length) {
                list.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-ticket-alt text-slate-300 text-xl mb-2"></i>
                        <p class="text-sm text-slate-400">Belum ada kupon</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            storeData.coupons.forEach((coupon, index) => {
                const now = Date.now();
                const start = coupon.startDate || 0;
                const end = coupon.endDate || Infinity;
                const isActive = now >= start && now <= end;
                const isExpired = now > end;
                const usageLimit = coupon.maxUsage === 0 ? 'âˆž' : coupon.maxUsage;
                const usedCount = coupon.usedCount || 0;
                const discountText = coupon.type === 'percentage' 
                    ? `${coupon.value}%` 
                    : `Rp ${coupon.value.toLocaleString('id-ID')}`;
                
                list.innerHTML += `
                    <div class="border border-slate-200 rounded-xl p-4 ${isExpired ? 'opacity-60' : ''}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="inline-block bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-bold px-3 py-1 rounded-full">${coupon.code}</span>
                                    <span class="text-xs ${isActive ? 'text-green-600' : isExpired ? 'text-red-600' : 'text-yellow-600'} font-bold">
                                        ${isActive ? 'AKTIF' : isExpired ? 'KADALUARSA' : 'BELUM AKTIF'}
                                    </span>
                                </div>
                                <div class="text-xs text-slate-600">
                                    Diskon: <span class="font-bold">${discountText}</span>
                                    ${coupon.minPurchase > 0 ? ` | Min: Rp ${coupon.minPurchase.toLocaleString('id-ID')}` : ''}
                                </div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="editAdmCoupon(${index})" class="w-8 h-8 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded flex items-center justify-center">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                                <button onclick="deleteAdmCoupon(${index})" class="w-8 h-8 bg-red-50 text-red-600 hover:bg-red-100 rounded flex items-center justify-center">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 space-y-1">
                            <div class="flex justify-between">
                                <span>Berlaku:</span>
                                <span>${new Date(coupon.startDate).toLocaleDateString('id-ID')} - ${new Date(coupon.endDate).toLocaleDateString('id-ID')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Penggunaan:</span>
                                <span>${usedCount}/${usageLimit}</span>
                            </div>
                            ${coupon.maxDiscount > 0 ? `
                                <div class="flex justify-between">
                                    <span>Maks. Diskon:</span>
                                    <span>Rp ${coupon.maxDiscount.toLocaleString('id-ID')}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        },
        
        editAdmCoupon: (index) => {
            const coupon = storeData.coupons[index];
            
            document.getElementById('admCouponCode').value = coupon.code;
            document.getElementById('admCouponType').value = coupon.type;
            document.getElementById('admCouponValue').value = coupon.value;
            document.getElementById('admCouponMin').value = coupon.minPurchase;
            document.getElementById('admCouponMax').value = coupon.maxDiscount;
            document.getElementById('admCouponStart').value = new Date(coupon.startDate).toISOString().split('T')[0];
            document.getElementById('admCouponEnd').value = new Date(coupon.endDate).toISOString().split('T')[0];
            document.getElementById('admCouponUsage').value = coupon.maxUsage;
            document.getElementById('admCouponEditIdx').value = index;
            
            toggleCouponValueType();
            document.getElementById('adminPanelCoupons').scrollIntoView({ behavior: 'smooth' });
            
            toastr.info("Edit kupon: " + coupon.code);
        },
        
        deleteAdmCoupon: async (index) => {
            if (!confirm("Hapus kupon ini?")) return;
            
            try {
                const couponCode = storeData.coupons[index].code;
                storeData.coupons.splice(index, 1);
                
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                
                renderAdmCouponList();
                updateCouponCount();
                
                toastr.success(`Kupon "${couponCode}" dihapus`);
            } catch (error) {
                console.error("Error deleting coupon:", error);
                toastr.error("Gagal menghapus kupon");
            }
        },
        
        resetAdmCouponForm: () => {
            document.getElementById('admCouponCode').value = "";
            document.getElementById('admCouponType').value = "percentage";
            document.getElementById('admCouponValue').value = "";
            document.getElementById('admCouponMin').value = "";
            document.getElementById('admCouponMax').value = "";
            document.getElementById('admCouponStart').value = "";
            document.getElementById('admCouponEnd').value = "";
            document.getElementById('admCouponUsage').value = "";
            document.getElementById('admCouponEditIdx').value = "-1";
            toggleCouponValueType();
        },
        
        // Store Settings
        saveAdmSettings: async () => {
            const name = document.getElementById('admStoreName').value.trim();
            const fee = parseFloat(document.getElementById('admFee').value) || 0;
            
            if (!name) {
                toastr.error("Nama toko harus diisi");
                return;
            }
            
            if (fee < 0) {
                toastr.error("Fee admin tidak boleh negatif");
                return;
            }
            
            try {
                storeData.name = name;
                storeData.fee = fee;
                
                await update(ref(db, `stores/${STORE_ID}`), storeData);
                
                document.getElementById('shopNameDisplay').innerText = name;
                toastr.success("Pengaturan toko disimpan");
            } catch (error) {
                console.error("Error saving settings:", error);
                toastr.error("Gagal menyimpan pengaturan");
            }
        },
        
        // Profile Functions
        handleAvatarUpload: (input) => {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                toastr.error("File harus berupa gambar");
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                toastr.error("Ukuran gambar maksimal 2MB");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    
                    // Resize to 200px max
                    if (w > 200) {
                        h = (h * 200) / w;
                        w = 200;
                    }
                    
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                    document.getElementById('profileAvatarEdit').src = dataUrl;
                    document.getElementById('headerAvatar').src = dataUrl;
                    userProfile.tempAvatar = dataUrl;
                    
                    toastr.success("Foto profil diperbarui");
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        },
        
        saveProfileData: async () => {
            const name = document.getElementById('profName').value.trim();
            const phone = document.getElementById('profPhone').value.trim();
            const address = document.getElementById('profAddress').value.trim();
            
            if (!name) {
                toastr.error("Nama harus diisi");
                return;
            }
            
            if (!phone) {
                toastr.error("Nomor WhatsApp harus diisi");
                return;
            }
            
            // Simple phone validation
            if (!/^[0-9]{10,13}$/.test(phone.replace(/[^0-9]/g, ''))) {
                toastr.error("Nomor WhatsApp tidak valid");
                return;
            }
            
            userProfile.name = name;
            userProfile.phone = phone;
            userProfile.address = address;
            
            if (userProfile.tempAvatar) {
                userProfile.avatar = userProfile.tempAvatar;
                delete userProfile.tempAvatar;
            }
            
            try {
                await update(ref(db, `users/${user.uid}`), userProfile);
                
                document.getElementById('headerGreeting').innerText = name;
                toastr.success("Profil berhasil disimpan");
            } catch (error) {
                console.error("Error saving profile:", error);
                toastr.error("Gagal menyimpan profil");
            }
        },
        
        loadProfile: async (uid) => {
            try {
                const snapshot = await get(child(ref(db), `users/${uid}`));
                if (snapshot.exists()) {
                    userProfile = snapshot.val();
                } else {
                    // Create default profile
                    userProfile = {
                        name: user.displayName || 'Pengguna',
                        email: user.email,
                        createdAt: Date.now()
                    };
                    await set(ref(db, `users/${uid}`), userProfile);
                }
                
                // Update UI
                document.getElementById('headerGreeting').innerText = userProfile.name;
                
                if (userProfile.avatar) {
                    document.getElementById('headerAvatar').src = userProfile.avatar;
                    document.getElementById('profileAvatarEdit').src = userProfile.avatar;
                }
                
                document.getElementById('profName').value = userProfile.name || '';
                document.getElementById('profPhone').value = userProfile.phone || '';
                document.getElementById('profAddress').value = userProfile.address || '';
                
                // Load order history
                const historySnapshot = await get(child(ref(db), `orders/${uid}`));
                const historyList = document.getElementById('historyList');
                const historyCount = document.getElementById('historyCount');
                
                if (historySnapshot.exists()) {
                    const orders = Object.values(historySnapshot.val()).reverse(); // Show newest first
                    historyList.innerHTML = '';
                    
                    orders.slice(0, 10).forEach(order => { // Show last 10 orders
                        const date = new Date(order.date);
                        const dateStr = date.toLocaleDateString('id-ID');
                        const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                        
                        historyList.innerHTML += `
                            <div class="bg-white border border-slate-200 rounded-lg p-3 hover:bg-slate-50 transition-colors">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-xs font-bold text-slate-700">${dateStr} ${timeStr}</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                        ${order.status === 'pending' ? 'Pending' : 'Selesai'}
                                    </span>
                                </div>
                                <div class="text-xs text-slate-500 mb-1">
                                    ${order.items?.length || 0} item â€¢ ${order.paymentMethod === 'allbank' ? 'All Bank' : 'DANA'}
                                </div>
                                <div class="text-sm font-bold text-blue-600">
                                    Rp ${parseInt(order.total || 0).toLocaleString('id-ID')}
                                </div>
                            </div>
                        `;
                    });
                    
                    historyCount.textContent = `${orders.length} pesanan`;
                } else {
                    historyList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-history text-slate-300 text-2xl mb-2"></i>
                            <p class="text-sm text-slate-400">Belum ada riwayat pesanan</p>
                        </div>
                    `;
                    historyCount.textContent = '0 pesanan';
                }
                
            } catch (error) {
                console.error("Error loading profile:", error);
            }
        },
        
        doLogout: () => {
            if (confirm("Yakin ingin keluar?")) {
                signOut(auth).then(() => {
                    location.reload();
                }).catch(error => {
                    console.error("Logout error:", error);
                    toastr.error("Gagal logout");
                });
            }
        },
        
        shareProduct: (i) => {
            const p = storeData.products[i];
            const url = window.location.href;
            const text = `*${p.name}*\nHarga: Rp ${parseInt(p.price).toLocaleString('id-ID')}\nStok: ${p.stock}\n${p.desc ? p.desc.substring(0, 100) + '...' : ''}\n\nLink: ${url}`;
            
            if (navigator.share) {
                navigator.share({
                    title: p.name,
                    text: text,
                    url: url
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(text);
                toastr.success("Info produk disalin ke clipboard!");
            }
        }
    });

    // --- INITIALIZE APP ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            
            // Setup admin PIN form
            document.getElementById('pinForm').addEventListener('submit', (e) => {
                e.preventDefault();
                window.checkAdmin();
            });
            
            // Toggle PIN visibility
            document.getElementById('togglePin').addEventListener('click', () => {
                const input = document.getElementById('adminPin');
                input.type = input.type === 'password' ? 'text' : 'password';
            });
            
            // Auto-hide loading screen after 2 seconds max
            setTimeout(() => {
                showLoading(false);
            }, 2000);
            
            // Auth state listener
            onAuthStateChanged(auth, (u) => {
                if (u) {
                    user = u;
                    isGuestMode = false;
                    
                    // Check if admin
                    if (u.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                        document.getElementById('nav-admin').classList.remove('hidden');
                    }
                    
                    // Hide login modal, show app
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    
                    // Load profile and store
                    loadProfile(u.uid).then(() => {
                        initStore();
                    });
                    
                    // Check for admin page parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('page') === 'admin') {
                        setTimeout(() => {
                            openAdminLogin();
                            // Remove parameter from URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }, 1000);
                    }
                } else {
                    // Not logged in, show login modal
                    document.getElementById('loginModal').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                }
            });
            
        } catch (error) {
            console.error("Firebase initialization error:", error);
            toastr.error("Gagal memuat aplikasi");
            showLoading(false);
        }
    });
  </script>
</body>
</html>
